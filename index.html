<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kachin Visions Empire</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="K. VE">
    
    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/png" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <!-- Import Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <!-- Import HLS.js for adaptive bitrate streaming -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    
    <!-- Import jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Import CryptoJS for encryption -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <!-- Import Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ===== GLOBAL STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        :root {
            --primary: #00f5ff;
            --secondary: #00b3ff;
            --accent: #ff00aa;
            --accent-glow: rgba(255, 0, 170, 0.7);
            --dark: #0a0a1a;
            --darker: #050510;
            --light: #f0f8ff;
            --gray: #8a93a7;
            --success: #00ffcc;
            --warning: #ffcc00;
            --danger: #ff3e3e;
            --card-bg: rgba(15, 20, 40, 0.8);
            --card-border: rgba(0, 245, 255, 0.3);
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            --card-glow: 0 0 25px rgba(0, 245, 255, 0.4);
            --transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --transition-slow: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        body {
            background: linear-gradient(135deg, var(--darker), var(--dark), #0f1a2a);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
            position: relative;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ===== SCREEN STYLES ===== */
        .screen {
            display: none;
            min-height: 100vh;
            padding: 20px;
            animation: fadeIn 0.5s ease-in-out;
            position: relative;
        }

        .active {
            display: block;
        }

        /* ===== HEADER STYLES ===== */
        .header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: flex-start;
            padding: 20px 0;
            margin-bottom: 30px;
            position: relative;
            gap: 20px;
        }

        .site-title {
            font-size: clamp(1.8rem, 4vw, 2.8rem);
            font-weight: 900;
            text-shadow: 0 0 25px rgba(0, 245, 255, 0.8);
            background: linear-gradient(to right, #ff00aa, #ff5500, #00f5ff, #00b3ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            letter-spacing: 1px;
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.5));
            position: relative;
            z-index: 2;
            flex: 1;
            min-width: 300px;
        }

        .back-btn-container {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
        }

        .back-btn {
            background: linear-gradient(135deg, var(--danger), #cc0000);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            transition: var(--transition);
            box-shadow: var(--card-shadow), 0 0 15px rgba(255, 62, 62, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .back-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 62, 62, 0.6);
        }

        /* ===== PASSWORD SECTION ===== */
        .password-section {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--card-shadow), var(--card-glow);
            z-index: 10;
            border: 1px solid var(--card-border);
            transition: var(--transition);
            flex: 0 1 400px;
            max-width: 100%;
        }

        .password-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6), 0 0 30px rgba(0, 245, 255, 0.5);
        }

        .password-section .form-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--accent);
            text-align: center;
            font-weight: 700;
            text-shadow: 0 0 10px var(--accent-glow);
        }

        .password-section .form-group {
            margin-bottom: 15px;
        }

        .password-section .form-input {
            padding: 12px 16px;
            font-size: 1rem;
            background: rgba(10, 15, 30, 0.8);
            border: 1px solid rgba(0, 245, 255, 0.3);
            border-radius: 10px;
            color: white;
            width: 100%;
            transition: var(--transition);
        }

        .password-section .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(0, 245, 255, 0.5);
        }

        .password-section .form-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .password-section .submit-btn {
            padding: 12px 16px;
            font-size: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            transition: var(--transition);
            width: 100%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }

        .password-section .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5), 0 0 15px rgba(0, 245, 255, 0.5);
        }

        /* ===== VIDEO PLAYER STYLES ===== */
        .video-section {
            display: flex;
            flex-direction: column;
            gap: 25px;
            margin-bottom: 30px;
        }

        .main-video-container {
            width: 100%;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--card-shadow), var(--card-glow);
            position: relative;
            aspect-ratio: 16/9;
            border: 1px solid var(--card-border);
            transition: var(--transition);
        }

        .main-video-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6), 0 0 30px rgba(0, 245, 255, 0.5);
        }

        .video-player {
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .video-player-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .black-bars {
            position: absolute;
            left: 0;
            right: 0;
            background: #000;
            z-index: 10;
            pointer-events: none;
        }

        .top-bar {
            top: 0;
        }

        .bottom-bar {
            bottom: 0;
        }

        .video-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
        }

        .video-list-container {
            width: 100%;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--card-shadow), var(--card-glow);
            border: 1px solid var(--card-border);
            transition: var(--transition);
        }

        .video-list-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6), 0 0 30px rgba(0, 245, 255, 0.5);
        }

        .video-list-title {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.4rem;
            color: var(--accent);
            font-weight: 700;
            text-shadow: 0 0 10px var(--accent-glow);
        }

        .video-list {
            max-height: 350px;
            overflow-y: auto;
            padding-right: 10px;
        }

        /* Custom scrollbar */
        .video-list::-webkit-scrollbar {
            width: 8px;
        }

        .video-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .video-list::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, var(--primary), var(--secondary));
            border-radius: 10px;
        }

        .video-list::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, var(--secondary), var(--primary));
        }

        .video-item {
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 12px;
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .video-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: var(--transition-slow);
        }

        .video-item:hover::before {
            left: 100%;
        }

        .video-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(8px);
            border-left-color: var(--accent);
        }

        .video-item.locked {
            background: rgba(255, 0, 0, 0.1);
            cursor: not-allowed;
        }

        .video-item.locked:hover {
            background: rgba(255, 0, 0, 0.2);
            transform: none;
            border-left-color: transparent;
        }

        .video-item.free {
            background: rgba(0, 255, 204, 0.05);
            border-left-color: var(--success);
        }

        .video-item.free:hover {
            background: rgba(0, 255, 204, 0.1);
        }

        .offline-badge {
            background: linear-gradient(135deg, var(--success), #00ccaa);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            margin-left: 10px;
            font-weight: 600;
            box-shadow: 0 3px 10px rgba(0, 255, 204, 0.4);
        }

        .free-badge {
            background: linear-gradient(135deg, var(--secondary), #0066cc);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            margin-left: 10px;
            font-weight: 600;
            box-shadow: 0 3px 10px rgba(0, 179, 255, 0.4);
        }

        /* ===== FORM STYLES ===== */
        .form-container {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--card-shadow), var(--card-glow);
            border: 1px solid var(--card-border);
            transition: var(--transition);
        }

        .form-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6), 0 0 30px rgba(0, 245, 255, 0.5);
        }

        .form-title {
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.5rem;
            color: var(--accent);
            font-weight: 700;
            text-shadow: 0 0 10px var(--accent-glow);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--light);
        }

        .form-input {
            width: 100%;
            padding: 16px;
            border-radius: 10px;
            border: 1px solid rgba(0, 245, 255, 0.3);
            background: rgba(10, 15, 30, 0.8);
            font-size: 1rem;
            color: white;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(0, 245, 255, 0.5);
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .form-textarea {
            width: 100%;
            padding: 16px;
            border-radius: 10px;
            border: 1px solid rgba(0, 245, 255, 0.3);
            background: rgba(10, 15, 30, 0.8);
            font-size: 1rem;
            min-height: 120px;
            resize: vertical;
            color: white;
            transition: var(--transition);
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(0, 245, 255, 0.5);
        }

        .form-textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .submit-btn {
            width: 100%;
            padding: 16px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, var(--success), #00ccaa);
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 5px 15px rgba(0, 255, 204, 0.4);
        }

        .submit-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 255, 204, 0.6);
        }

        /* ===== BUTTON STYLES ===== */
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 25px;
        }

        .nav-btn {
            padding: 16px 28px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: var(--card-shadow), var(--card-glow);
        }

        .nav-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.6), 0 0 25px rgba(0, 245, 255, 0.6);
        }

        .nav-btn.back {
            background: linear-gradient(135deg, var(--danger), #cc0000);
        }

        .nav-btn.back:hover {
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.6), 0 0 25px rgba(255, 62, 62, 0.6);
        }

        .admin-login-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            transition: var(--transition);
            box-shadow: var(--card-shadow), var(--card-glow);
            width: 100%;
            max-width: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            font-size: 1rem;
            letter-spacing: 0.5px;
        }

        .admin-login-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.6), 0 0 25px rgba(0, 245, 255, 0.6);
        }

        /* ===== ADMIN SECTION STYLES ===== */
        .admin-section {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--card-shadow), var(--card-glow);
            border: 1px solid var(--card-border);
            transition: var(--transition);
        }

        .admin-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6), 0 0 30px rgba(0, 245, 255, 0.5);
        }

        .admin-title {
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.7rem;
            color: var(--accent);
            font-weight: 700;
            text-shadow: 0 0 10px var(--accent-glow);
        }

        .video-source-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 25px;
        }

        .source-input {
            width: 100%;
            padding: 16px;
            border-radius: 10px;
            border: 1px solid rgba(0, 245, 255, 0.3);
            background: rgba(10, 15, 30, 0.8);
            color: white;
            transition: var(--transition);
        }

        .source-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(0, 245, 255, 0.5);
        }

        .source-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .add-btn {
            padding: 16px 24px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, var(--success), #00ccaa);
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0, 255, 204, 0.4);
        }

        .add-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 255, 204, 0.6);
        }

        .user-list, .video-admin-list {
            margin-top: 25px;
        }

        .user-item, .video-admin-item {
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 15px;
            padding: 20px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border-left: 4px solid var(--primary);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .user-item::before, .video-admin-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: var(--transition-slow);
        }

        .user-item:hover::before, .video-admin-item:hover::before {
            left: 100%;
        }

        .user-item:hover, .video-admin-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .user-info, .video-admin-info {
            flex: 1;
        }

        .user-actions, .video-admin-actions {
            display: flex;
            gap: 12px;
        }

        .edit-btn, .delete-btn, .reset-device-btn, .export-btn, .bulk-delete-btn, .cache-btn, .move-up-btn, .move-down-btn, .first-play-btn {
            padding: 12px 18px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .edit-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .delete-btn {
            background: linear-gradient(135deg, var(--danger), #cc0000);
            color: white;
        }

        .reset-device-btn {
            background: linear-gradient(135deg, var(--warning), #e6b400);
            color: white;
        }

        .export-btn {
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            color: white;
        }

        .bulk-delete-btn {
            background: linear-gradient(135deg, #9C27B0, #E91E63);
            color: white;
        }

        .cache-btn {
            background: linear-gradient(135deg, var(--success), #00ccaa);
            color: white;
        }

        .move-up-btn {
            background: linear-gradient(135deg, var(--warning), #e6b400);
            color: white;
        }

        .move-down-btn {
            background: linear-gradient(135deg, #2196F3, #03A9F4);
            color: white;
        }

        .first-play-btn {
            background: linear-gradient(135deg, #9C27B0, #E91E63);
            color: white;
        }

        .first-play-btn.active {
            background: linear-gradient(135deg, var(--success), #00ccaa);
            box-shadow: 0 0 15px rgba(0, 255, 204, 0.6);
        }

        .edit-btn:hover, .delete-btn:hover, .reset-device-btn:hover, .export-btn:hover, .bulk-delete-btn:hover, .cache-btn:hover, .move-up-btn:hover, .move-down-btn:hover, .first-play-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }

        .online-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .online {
            background: var(--success);
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.6);
        }

        .offline {
            background: var(--danger);
        }

        .device-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
        }

        .device-list {
            margin-top: 12px;
        }

        .device-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ===== MODAL STYLES ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .modal-content {
            background: linear-gradient(135deg, var(--dark), #1a1a2e);
            padding: 30px;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            box-shadow: var(--card-shadow), var(--card-glow);
            border: 1px solid var(--card-border);
            animation: modalSlideIn 0.4s ease-out;
        }

        .modal-title {
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.7rem;
            color: var(--accent);
            font-weight: 700;
            text-shadow: 0 0 10px var(--accent-glow);
        }

        .close-modal {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--accent);
            transition: var(--transition);
        }

        .close-modal:hover {
            transform: scale(1.2);
        }

        /* ===== PASSWORD GENERATION STYLES ===== */
        .password-generation-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 25px;
        }

        .generated-passwords {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            max-height: 250px;
            overflow-y: auto;
        }

        .password-item {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }

        .password-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .password-item:last-child {
            border-bottom: none;
        }

        .copy-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
        }

        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* ===== CONTACT LINKS STYLES ===== */
        .contact-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .contact-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 24px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 700;
            transition: var(--transition);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            min-width: 160px;
            justify-content: center;
        }

        .facebook-btn {
            background: linear-gradient(135deg, #1877F2, #0A5BC4);
            color: white;
        }

        .telegram-btn {
            background: linear-gradient(135deg, #0088cc, #006699);
            color: white;
        }

        .viber-btn {
            background: linear-gradient(135deg, #7360F2, #5A4FCF);
            color: white;
        }

        .contact-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        /* ===== INSTAGRAM & TIKTOK VIDEO STYLES ===== */
        .instagram-iframe, .tiktok-iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 12px;
        }

        .instagram-container, .tiktok-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* ===== SEARCH BAR STYLES ===== */
        .search-container {
            margin-bottom: 25px;
        }

        .search-input {
            width: 100%;
            padding: 16px;
            border-radius: 10px;
            border: 1px solid rgba(0, 245, 255, 0.3);
            background: rgba(10, 15, 30, 0.8);
            font-size: 1rem;
            color: white;
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(0, 245, 255, 0.5);
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        /* ===== STORAGE STATUS ===== */
        .storage-status {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 12px;
            margin: 25px 0;
            text-align: center;
            transition: var(--transition);
        }

        .storage-status:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        .storage-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            margin-top: 8px;
            overflow: hidden;
        }

        .storage-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--success), #00ccaa);
            border-radius: 10px;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.6);
        }

        /* ===== CONNECTION STATUS ===== */
        .connection-status {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1000;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }

        .online-status-badge {
            background: linear-gradient(135deg, var(--success), #00ccaa);
        }

        .offline-status-badge {
            background: linear-gradient(135deg, var(--danger), #cc0000);
        }

        /* ===== ADMIN MESSAGE STYLES ===== */
        .admin-message-container {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--card-shadow), var(--card-glow);
            border: 1px solid var(--card-border);
            transition: var(--transition);
        }

        .admin-message-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6), 0 0 30px rgba(0, 245, 255, 0.5);
        }

        .admin-message-title {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.5rem;
            color: var(--accent);
            font-weight: 700;
            text-shadow: 0 0 10px var(--accent-glow);
        }

        .admin-message-content {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            min-height: 100px;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }

        /* ===== RICH TEXT EDITOR STYLES ===== */
        .rich-text-editor {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 245, 255, 0.3);
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 1px solid rgba(0, 245, 255, 0.3);
        }

        .toolbar-group {
            display: flex;
            gap: 8px;
            margin-right: 15px;
        }

        .toolbar-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .toolbar-btn.active {
            background: var(--primary);
        }

        .toolbar-select {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
        }

        .toolbar-color {
            width: 45px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.2);
        }

        .editor-content {
            min-height: 250px;
            padding: 20px;
            color: #333;
            font-size: 1rem;
            line-height: 1.6;
            outline: none;
            overflow-y: auto;
            max-height: 350px;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            background: white;
        }

        .editor-content:empty:before {
            content: "Type your admin message here...";
            color: #999;
        }

        /* ===== YOUTUBE VIDEO STYLES ===== */
        .youtube-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* ===== FULLSCREEN STYLES ===== */
        .fullscreen-btn {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 10;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
        }

        .fullscreen-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: translateY(-3px);
        }

        /* ===== ERROR MESSAGE STYLES ===== */
        .error-message {
            color: var(--danger);
            text-align: center;
            padding: 25px;
            background: rgba(255, 0, 0, 0.1);
            border-radius: 12px;
            margin: 15px 0;
            border: 1px solid rgba(255, 0, 0, 0.2);
        }

        /* ===== TEXT SELECTION TOOLBAR ===== */
        .text-selection-toolbar {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 10px;
            display: none;
            flex-wrap: wrap;
            gap: 8px;
            z-index: 1000;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        .selection-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
        }

        .selection-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* ===== BLACK BAR CONFIGURATION STYLES ===== */
        .black-bar-config {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .bar-config-group {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
            align-items: center;
        }

        .bar-config-label {
            min-width: 140px;
            font-weight: 600;
        }

        .bar-config-input {
            width: 90px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(0, 245, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .bar-config-btn {
            padding: 10px 18px;
            border-radius: 8px;
            border: none;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .bar-config-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }

        /* ===== VIDEO REORDERING STYLES ===== */
        .video-admin-item.dragging {
            opacity: 0.5;
            background: rgba(255, 255, 255, 0.2);
        }

        .video-admin-item.drag-over {
            border: 2px dashed var(--accent);
        }

        .video-order-controls {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .order-btn {
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
        }

        .order-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .order-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ===== NO INTERNET CONNECTION MODAL ===== */
        .no-internet-modal {
            background: linear-gradient(135deg, var(--dark), #1a1a2e);
            padding: 30px;
            border-radius: 16px;
            width: 100%;
            max-width: 450px;
            box-shadow: var(--card-shadow), var(--card-glow);
            text-align: center;
            border: 1px solid var(--card-border);
            animation: modalSlideIn 0.4s ease-out;
        }

        .no-internet-icon {
            font-size: 3.5rem;
            margin-bottom: 20px;
            color: var(--accent);
            text-shadow: 0 0 15px var(--accent-glow);
        }

        /* ===== CONTACT LINKS SCREEN STYLES ===== */
        .contact-links-screen {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--card-shadow), var(--card-glow);
            border: 1px solid var(--card-border);
            transition: var(--transition);
        }

        .contact-links-screen:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.6), 0 0 30px rgba(0, 245, 255, 0.5);
        }

        .contact-link-screen-item {
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 15px;
            padding: 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: var(--transition);
            border-left: 4px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .contact-link-screen-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: var(--transition-slow);
        }

        .contact-link-screen-item:hover::before {
            left: 100%;
        }

        .contact-link-screen-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(8px);
            border-left-color: var(--accent);
        }

        .contact-link-screen-icon {
            font-size: 1.8rem;
            width: 50px;
            text-align: center;
        }

        .contact-link-screen-info {
            flex: 1;
        }

        .contact-link-screen-name {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .contact-link-screen-type {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .contact-link-screen-btn {
            padding: 10px 18px;
            border-radius: 25px;
            text-decoration: none;
            color: white;
            font-weight: 700;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .facebook-screen-btn {
            background: linear-gradient(135deg, #1877F2, #0A5BC4);
        }

        .telegram-screen-btn {
            background: linear-gradient(135deg, #0088cc, #006699);
        }

        .viber-screen-btn {
            background: linear-gradient(135deg, #7360F2, #5A4FCF);
        }

        .other-screen-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .contact-link-screen-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        /* ===== DIGITAL BACKGROUND ELEMENTS ===== */
        .digital-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 0, 170, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 245, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 85, 0, 0.15) 0%, transparent 50%);
            z-index: -1;
        }

        .digital-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 245, 255, 0.07) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 245, 255, 0.07) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: -1;
            opacity: 0.6;
        }

        .digital-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            background: rgba(0, 245, 255, 0.5);
            border-radius: 50%;
            animation: float 15s infinite linear;
        }

        @keyframes float {
            0% {
                transform: translateY(0) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) translateX(100px);
                opacity: 0;
            }
        }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes glow {
            0% { box-shadow: 0 0 5px rgba(0, 245, 255, 0.6); }
            50% { box-shadow: 0 0 20px rgba(0, 245, 255, 0.9); }
            100% { box-shadow: 0 0 5px rgba(0, 245, 255, 0.6); }
        }

        /* ===== LOADING ANIMATION ===== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== VIDEO QUALITY SELECTOR ===== */
        .quality-selector {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 10;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .quality-selector:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        /* ===== VIDEO AUTO-PLAY ANIMATION ===== */
        .video-item.playing {
            animation: pulse 2s infinite;
            border-left-color: var(--accent);
            box-shadow: 0 0 15px rgba(255, 0, 170, 0.4);
        }

        /* ===== CONTACT LINK MANAGEMENT STYLES ===== */
        .contact-link-item {
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 15px;
            padding: 20px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border-left: 4px solid transparent;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .contact-link-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: var(--transition-slow);
        }

        .contact-link-item:hover::before {
            left: 100%;
        }

        .contact-link-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .contact-link-info {
            flex: 1;
        }

        .contact-link-actions {
            display: flex;
            gap: 12px;
        }

        .contact-link-item.free {
            border-left-color: var(--success);
        }

        .contact-link-item.password-protected {
            border-left-color: var(--warning);
        }

        .contact-link-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            margin-left: 12px;
            background: var(--success);
            color: white;
            font-weight: 600;
            box-shadow: 0 3px 10px rgba(0, 255, 204, 0.4);
        }

        .contact-link-badge.password {
            background: var(--warning);
            box-shadow: 0 3px 10px rgba(255, 204, 0, 0.4);
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (min-width: 768px) {
            .container {
                padding: 30px;
            }
            
            .screen {
                padding: 30px;
            }
            
            .header {
                flex-direction: row;
                justify-content: space-between;
                text-align: left;
            }
            
            .site-title {
                font-size: 2.5rem;
                margin-bottom: 0;
            }
            
            .admin-login-btn {
                width: auto;
            }
            
            .video-section {
                flex-direction: row;
            }
            
            .main-video-container {
                flex: 2;
            }
            
            .video-list-container {
                flex: 1;
            }
            
            .btn-group {
                flex-direction: row;
                justify-content: space-between;
            }
            
            .nav-btn {
                width: auto;
            }
            
            .video-source-form {
                flex-direction: row;
            }
            
            .user-item, .video-admin-item {
                flex-direction: row;
                align-items: flex-start;
            }
            
            .user-actions, .video-admin-actions {
                flex-direction: column;
            }
            
            .password-generation-container {
                flex-direction: row;
            }
            
            .generated-passwords {
                flex: 1;
            }
            
            .contact-links {
                flex-direction: row;
            }

            .toolbar {
                flex-wrap: nowrap;
            }
            
            .text-selection-toolbar {
                flex-wrap: nowrap;
            }
            
            .bar-config-group {
                flex-direction: row;
            }

            .video-order-controls {
                flex-direction: row;
                margin-top: 0;
                margin-left: 15px;
            }
        }

        @media (min-width: 992px) {
            .container {
                padding: 40px;
            }
        }
        
        /* ===== PWA INSTALL PROMPT ===== */
        .pwa-install-prompt {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--card-shadow), var(--card-glow);
            border: 1px solid var(--card-border);
            z-index: 10000;
            max-width: 350px;
            animation: slideIn 0.5s ease-out;
        }
        
        .pwa-install-prompt.hidden {
            display: none;
        }
        
        .pwa-install-prompt-content {
            text-align: center;
        }
        
        .pwa-install-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--accent);
        }
        
        .pwa-install-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .pwa-install-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .pwa-install-btn.primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        
        .pwa-install-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .pwa-install-btn:hover {
            transform: translateY(-3px);
        }
    </style>
</head>
<body>
    <div class="digital-bg"></div>
    <div class="digital-grid"></div>
    <div class="digital-particles" id="particles"></div>
    
    <!-- PWA Install Prompt -->
    <div id="pwaInstallPrompt" class="pwa-install-prompt hidden">
        <div class="pwa-install-prompt-content">
            <div class="pwa-install-icon"><i class="fas fa-download"></i></div>
            <h3>Install Kachin Visions Empire</h3>
            <p>Install this app on your device for quick access and offline viewing.</p>
            <div class="pwa-install-buttons">
                <button id="pwaInstallCancel" class="pwa-install-btn secondary">Later</button>
                <button id="pwaInstallConfirm" class="pwa-install-btn primary">Install</button>
            </div>
        </div>
    </div>
    
    <!-- Connection Status Indicator -->
    <div id="connectionStatus" class="connection-status online-status-badge" style="display: none;">
        <i class="fas fa-wifi"></i> Online
    </div>

    <!-- No Internet Connection Modal -->
    <div id="noInternetModal" class="modal">
        <div class="no-internet-modal">
            <div class="no-internet-icon"><i class="fas fa-wifi-slash"></i></div>
            <h2 class="modal-title">No Internet Connection</h2>
            <p>You are currently offline. Some features may be limited.</p>
            <div class="btn-group" style="margin-top: 25px;">
                <button id="continueOfflineBtn" class="nav-btn"><i class="fas fa-play-circle"></i> Continue Offline</button>
            </div>
        </div>
    </div>

    <!-- Text Selection Toolbar -->
    <div id="textSelectionToolbar" class="text-selection-toolbar">
        <button class="selection-btn" data-command="bold" title="Bold"><i class="fas fa-bold"></i></button>
        <button class="selection-btn" data-command="italic" title="Italic"><i class="fas fa-italic"></i></button>
        <button class="selection-btn" data-command="underline" title="Underline"><i class="fas fa-underline"></i></button>
        <input type="color" class="toolbar-color" id="selectionTextColor" title="Text Color" value="#000000">
        <input type="color" class="toolbar-color" id="selectionBgColor" title="Background Color" value="#ffffff">
        <select class="toolbar-select" id="selectionFontSize">
            <option value="">Size</option>
            <option value="12px">Small</option>
            <option value="14px">Normal</option>
            <option value="16px">Medium</option>
            <option value="18px">Large</option>
            <option value="20px">X-Large</option>
        </select>
        <select class="toolbar-select" id="selectionFontFamily">
            <option value="">Font</option>
            <option value="Arial, sans-serif">Arial</option>
            <option value="'Times New Roman', serif">Times</option>
            <option value="'Courier New', monospace">Courier</option>
        </select>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeModal"><i class="fas fa-times"></i></span>
            <h2 class="modal-title">Admin Login</h2>
            <div class="form-group">
                <label class="form-label">User Name</label>
                <input type="text" id="adminUsername" class="form-input" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" id="adminPassword" class="form-input" placeholder="Enter password">
            </div>
            <button id="loginBtn" class="submit-btn"><i class="fas fa-sign-in-alt"></i> Login</button>
            <p id="loginMessage" style="text-align: center; margin-top: 20px;"></p>
        </div>
    </div>

    <!-- Screen 1: Main Video Screen -->
    <div id="screen1" class="screen active">
        <div class="container">
            <div class="back-btn-container">
                <button class="back-btn" style="display: none;"><i class="fas fa-arrow-left"></i> Back</button>
            </div>
            <div class="header">
                <h1 class="site-title">Kachin Visions Empire</h1>
                <div class="password-section">
                    <h2 class="form-title"><i class="fas fa-lock"></i> Sumla Hkrung Yu Na Matu</h2>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="password" class="form-input" placeholder="Enter your password">
                    </div>
                    <button id="unlockVideosBtn" class="submit-btn"><i class="fas fa-unlock"></i> Unlock Videos</button>
                    <p id="loginStatus" style="text-align: center; margin-top: 20px; font-size: 0.9rem;"></p>
                </div>
            </div>

            <div class="video-section">
                <div class="main-video-container">
                    <div id="mainVideoPlayer" class="video-player">
                        <div class="video-player-wrapper">
                            <div id="topBlackBar" class="black-bars top-bar" style="height: 0px;"></div>
                            <div class="video-content">
                                <!-- Video player will be dynamically set here -->
                                <video id="mainVideoElement" controls autoplay muted loop controlsList="nodownload" style="width: 100%; height: 100%;">
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                            <div id="bottomBlackBar" class="black-bars bottom-bar" style="height: 0px;"></div>
                        </div>
                    </div>
                    <button id="fullscreenBtn" class="fullscreen-btn" style="display: none;"><i class="fas fa-expand"></i> Full Screen</button>
                    <select id="qualitySelector" class="quality-selector" style="display: none;">
                        <option value="auto">Auto Quality</option>
                        <option value="high">High Quality</option>
                        <option value="medium">Medium Quality</option>
                        <option value="low">Low Quality</option>
                    </select>
                </div>
                <div class="video-list-container">
                    <h3 class="video-list-title"><i class="fas fa-film"></i> Video Library</h3>
                    
                    <div id="videoList" class="video-list">
                        <!-- Video items will be dynamically added here -->
                    </div>
                    
                    <!-- Admin Message Section - MOVED HERE UNDER VIDEO LIBRARY -->
                    <div class="admin-message-container">
                        <h2 class="admin-message-title"><i class="fas fa-bullhorn"></i> Matut Mahkai Hkring Dat</h2>
                        <div id="adminMessageContent" class="admin-message-content">
                            <!-- Admin message will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sumla Hkrung Dingsa Ni Button -->
            <div class="btn-group">
                <button id="showContactLinksScreen" class="nav-btn"><i class="fas fa-address-book"></i> Sumla Hkrung Dingsa Ni</button>
            </div>

            <!-- Storage Status - Moved to bottom -->
            <div class="storage-status">
                <div><i class="fas fa-hdd"></i> Offline Storage: <span id="storageUsage">0.00 MB</span> used</div>
                <div class="storage-bar">
                    <div id="storageFill" class="storage-fill" style="width: 0%"></div>
                </div>
                <small>Videos cached for offline viewing</small>
            </div>

            <div class="btn-group">
                <button id="clearCacheBtn" class="nav-btn back"><i class="fas fa-trash-alt"></i> Clear Offline Cache</button>
                <button id="adminLoginBtn" class="admin-login-btn"><i class="fas fa-user-shield"></i> Admin Login</button>
            </div>
        </div>
    </div>

    <!-- Screen 2: Admin Video Management -->
    <div id="screen2" class="screen">
        <div class="container">
            <div class="back-btn-container">
                <button id="backToScreen1" class="back-btn"><i class="fas fa-arrow-left"></i> Back</button>
            </div>
            <div class="header">
                <h1 class="site-title">Kachin Visions Empire</h1>
                <div></div> <!-- Empty div for spacing -->
            </div>

            <!-- Admin Message Management -->
            <div class="admin-section">
                <h2 class="admin-title"><i class="fas fa-comment-alt"></i> Admin Message Management</h2>
                
                <!-- Rich Text Editor -->
                <div class="rich-text-editor">
                    <div class="toolbar">
                        <div class="toolbar-group">
                            <button class="toolbar-btn" data-command="bold" title="Bold"><i class="fas fa-bold"></i></button>
                            <button class="toolbar-btn" data-command="italic" title="Italic"><i class="fas fa-italic"></i></button>
                            <button class="toolbar-btn" data-command="underline" title="Underline"><i class="fas fa-underline"></i></button>
                        </div>
                        
                        <div class="toolbar-group">
                            <select class="toolbar-select" id="fontFamily">
                                <option value="">Font Family</option>
                                <option value="Arial, sans-serif">Arial</option>
                                <option value="'Times New Roman', serif">Times New Roman</option>
                                <option value="'Courier New', monospace">Courier New</option>
                                <option value="Georgia, serif">Georgia</option>
                                <option value="Verdana, sans-serif">Verdana</option>
                                <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                            </select>
                            
                            <select class="toolbar-select" id="fontSize">
                                <option value="">Size</option>
                                <option value="12px">Small</option>
                                <option value="14px">Normal</option>
                                <option value="16px">Medium</option>
                                <option value="18px">Large</option>
                                <option value="20px">X-Large</option>
                                <option value="24px">XX-Large</option>
                            </select>
                            
                            <!-- Font Size Input from 1 to 100 -->
                            <div class="toolbar-group">
                                <input type="number" id="customFontSize" class="toolbar-input" min="1" max="100" placeholder="Size (1-100)" style="width: 90px; padding: 10px; border-radius: 8px; border: none; background: rgba(255, 255, 255, 0.2); color: white;">
                                <button id="applyCustomFontSize" class="toolbar-btn">Apply Size</button>
                            </div>
                        </div>
                        
                        <div class="toolbar-group">
                            <button class="toolbar-btn" data-command="justifyLeft" title="Align Left"><i class="fas fa-align-left"></i></button>
                            <button class="toolbar-btn" data-command="justifyCenter" title="Align Center"><i class="fas fa-align-center"></i></button>
                            <button class="toolbar-btn" data-command="justifyRight" title="Align Right"><i class="fas fa-align-right"></i></button>
                            <button class="toolbar-btn" data-command="justifyFull" title="Justify"><i class="fas fa-align-justify"></i></button>
                        </div>
                        
                        <div class="toolbar-group">
                            <button class="toolbar-btn" data-command="insertUnorderedList" title="Bullet List"><i class="fas fa-list-ul"></i></button>
                            <button class="toolbar-btn" data-command="insertOrderedList" title="Numbered List"><i class="fas fa-list-ol"></i></button>
                            <button class="toolbar-btn" data-command="outdent" title="Decrease Indent"><i class="fas fa-outdent"></i></button>
                            <button class="toolbar-btn" data-command="indent" title="Increase Indent"><i class="fas fa-indent"></i></button>
                        </div>
                        
                        <div class="toolbar-group">
                            <input type="color" class="toolbar-color" id="textColor" title="Text Color" value="#000000">
                            <input type="color" class="toolbar-color" id="backgroundColor" title="Background Color" value="#ffffff">
                        </div>
                        
                        <div class="toolbar-group">
                            <button class="toolbar-btn" data-command="removeFormat" title="Clear Formatting"><i class="fas fa-eraser"></i></button>
                            <button class="toolbar-btn" id="previewMessage" title="Preview Message"><i class="fas fa-eye"></i></button>
                        </div>
                    </div>
                    
                    <div id="adminMessageEditor" class="editor-content" contenteditable="true">
                        <!-- Rich text editor content -->
                    </div>
                </div>
                
                <button id="saveAdminMessage" class="submit-btn"><i class="fas fa-save"></i> Save Admin Message</button>
            </div>

            <div class="admin-section">
                <h2 class="admin-title"><i class="fas fa-plus-circle"></i> Add Video Sources</h2>
                
                <div class="video-source-form">
                    <input type="text" id="cloudinaryName" class="source-input" placeholder="Cloudinary Display Name">
                    <input type="text" id="cloudinaryUrl" class="source-input" placeholder="Cloudinary URL">
                    <select id="cloudinaryPasswordType" class="source-input">
                        <option value="free">Free Video (No Password)</option>
                        <option value="password">Password Protected</option>
                    </select>
                    <button id="addCloudinaryBtn" class="add-btn"><i class="fas fa-cloud-upload-alt"></i> Add Cloudinary Video</button>
                </div>

                <div class="video-source-form">
                    <input type="text" id="youtubeUrl" class="source-input" placeholder="YouTube Video URL">
                    <select id="youtubePasswordType" class="source-input">
                        <option value="free">Free Video (No Password)</option>
                        <option value="password">Password Protected</option>
                    </select>
                    <button id="addYoutubeBtn" class="add-btn"><i class="fab fa-youtube"></i> Add YouTube Video</button>
                </div>

                <div class="video-source-form">
                    <input type="text" id="telegramUrl" class="source-input" placeholder="Telegram Video URL">
                    <select id="telegramPasswordType" class="source-input">
                        <option value="free">Free Video (No Password)</option>
                        <option value="password">Password Protected</option>
                    </select>
                    <button id="addTelegramBtn" class="add-btn"><i class="fab fa-telegram"></i> Add Telegram Video</button>
                </div>

                <div class="video-source-form">
                    <input type="text" id="hlsUrl" class="source-input" placeholder="HLS Stream URL (.m3u8)">
                    <select id="hlsPasswordType" class="source-input">
                        <option value="free">Free Video (No Password)</option>
                        <option value="password">Password Protected</option>
                    </select>
                    <button id="addHlsBtn" class="add-btn"><i class="fas fa-stream"></i> Add HLS Stream</button>
                </div>

                <!-- Instagram Video Input -->
                <div class="video-source-form">
                    <input type="text" id="instagramUrl" class="source-input" placeholder="Instagram Video URL">
                    <select id="instagramPasswordType" class="source-input">
                        <option value="free">Free Video (No Password)</option>
                        <option value="password">Password Protected</option>
                    </select>
                    <button id="addInstagramBtn" class="add-btn"><i class="fab fa-instagram"></i> Add Instagram Video</button>
                </div>

                <!-- TikTok Video Input -->
                <div class="video-source-form">
                    <input type="text" id="tiktokUrl" class="source-input" placeholder="TikTok Video URL">
                    <select id="tiktokPasswordType" class="source-input">
                        <option value="free">Free Video (No Password)</option>
                        <option value="password">Password Protected</option>
                    </select>
                    <button id="addTiktokBtn" class="add-btn"><i class="fab fa-tiktok"></i> Add TikTok Video</button>
                </div>
            </div>

            <!-- UPDATED: Contact Links Management Section -->
            <div class="admin-section">
                <h2 class="admin-title"><i class="fas fa-address-book"></i> Manage Contact Links</h2>
                
                <div class="video-source-form">
                    <input type="text" id="contactLinkUrl" class="source-input" placeholder="Contact Link URL">
                    <input type="text" id="contactLinkName" class="source-input" placeholder="Display Name">
                    <select id="contactLinkType" class="source-input">
                        <option value="facebook">Facebook</option>
                        <option value="telegram">Telegram</option>
                        <option value="viber">Viber</option>
                        <option value="other">Other</option>
                    </select>
                    <select id="contactLinkAccess" class="source-input">
                        <option value="free">Free Access (No Password)</option>
                        <option value="password">Password Protected</option>
                    </select>
                    <button id="addContactLinkBtn" class="add-btn"><i class="fas fa-plus"></i> Add Contact Link</button>
                </div>

                <div class="admin-controls">
                    <button id="saveContactLinksOrderBtn" class="add-btn" style="margin-bottom: 20px;"><i class="fas fa-save"></i> Save Contact Links Order</button>
                </div>
                
                <div id="contactLinksAdminList" class="video-admin-list">
                    <!-- Contact link items will be dynamically added here -->
                </div>
            </div>

            <div class="admin-section">
                <h2 class="admin-title"><i class="fas fa-sliders-h"></i> Video Display Settings</h2>
                
                <div class="black-bar-config">
                    <h3 style="margin-bottom: 20px; color: var(--accent);">Black Bar Configuration</h3>
                    
                    <div class="bar-config-group">
                        <span class="bar-config-label">Top Bar Height:</span>
                        <input type="number" id="topBarHeight" class="bar-config-input" min="0" max="200" value="0">
                        <span>px</span>
                        <button id="applyTopBar" class="bar-config-btn">Apply</button>
                    </div>
                    
                    <div class="bar-config-group">
                        <span class="bar-config-label">Bottom Bar Height:</span>
                        <input type="number" id="bottomBarHeight" class="bar-config-input" min="0" max="200" value="0">
                        <span>px</span>
                        <button id="applyBottomBar" class="bar-config-btn">Apply</button>
                    </div>
                    
                    <div class="bar-config-group">
                        <span class="bar-config-label">Apply to All Videos:</span>
                        <button id="applyToAllVideos" class="bar-config-btn">Apply Settings</button>
                        <button id="resetBars" class="bar-config-btn" style="background: linear-gradient(135deg, var(--danger), #cc0000);">Reset</button>
                    </div>
                </div>
            </div>

            <div class="admin-section">
                <h2 class="admin-title"><i class="fas fa-film"></i> Manage Existing Videos</h2>
                <div class="admin-controls">
                    <button id="saveVideoOrderBtn" class="add-btn" style="margin-bottom: 20px;"><i class="fas fa-save"></i> Save Video Order</button>
                </div>
                <div id="videoAdminList" class="video-admin-list">
                    <!-- Admin video items will be dynamically added here -->
                </div>
            </div>

            <div class="btn-group">
                <button id="nextToScreen3" class="nav-btn"><i class="fas fa-arrow-right"></i> Next Screen</button>
            </div>
        </div>
    </div>

    <!-- Screen 3: User Management -->
    <div id="screen3" class="screen">
        <div class="container">
            <div class="back-btn-container">
                <button id="backToScreen2" class="back-btn"><i class="fas fa-arrow-left"></i> Back</button>
            </div>
            <div class="header">
                <h1 class="site-title">Kachin Visions Empire</h1>
                <div></div> <!-- Empty div for spacing -->
            </div>

            <div class="admin-section">
                <h2 class="admin-title"><i class="fas fa-key"></i> Password Management</h2>
                
                <div class="password-generation-container">
                    <div class="form-container" style="flex: 1;">
                        <h3 class="form-title">Generate Passwords</h3>
                        <div class="form-group">
                            <label class="form-label">Number of Passwords to Generate</label>
                            <input type="number" id="passwordCount" class="form-input" value="10" min="1" max="50">
                        </div>
                        <button id="generatePasswordBtn" class="submit-btn"><i class="fas fa-key"></i> Generate Passwords</button>
                    </div>
                    
                    <div class="generated-passwords" id="generatedPasswords">
                        <h4 style="margin-bottom: 15px; text-align: center;">Recently Generated Passwords</h4>
                        <!-- Generated passwords will appear here -->
                    </div>
                </div>

                <div class="search-container">
                    <input type="text" id="passwordSearch" class="search-input" placeholder="Search passwords...">
                </div>

                <div class="user-list" id="userList">
                    <!-- Password items will be dynamically added here -->
                </div>

                <div class="admin-section">
                    <h2 class="admin-title"><i class="fas fa-file-export"></i> Export Passwords</h2>
                    <div class="btn-group">
                        <button id="exportUnusedTxtBtn" class="export-btn"><i class="fas fa-file-alt"></i> Export Unused as TXT</button>
                        <button id="exportUnusedPdfBtn" class="export-btn"><i class="fas fa-file-pdf"></i> Export Unused as PDF</button>
                        <button id="exportUsedTxtBtn" class="export-btn"><i class="fas fa-file-alt"></i> Export Used as TXT</button>
                        <button id="exportUsedPdfBtn" class="export-btn"><i class="fas fa-file-pdf"></i> Export Used as PDF</button>
                    </div>
                </div>

                <div class="admin-section">
                    <h2 class="admin-title"><i class="fas fa-trash-alt"></i> Bulk Password Management</h2>
                    <div class="btn-group">
                        <button id="deleteUsedPasswordsBtn" class="bulk-delete-btn"><i class="fas fa-trash"></i> Delete Used Passwords</button>
                        <button id="deleteUnusedPasswordsBtn" class="bulk-delete-btn"><i class="fas fa-trash"></i> Delete Unused Passwords</button>
                        <button id="deleteAllPasswordsBtn" class="bulk-delete-btn"><i class="fas fa-trash"></i> Delete All Passwords</button>
                    </div>
                </div>

                <div class="admin-section" id="secondAdminSection" style="display: none;">
                    <h2 class="admin-title"><i class="fas fa-user-plus"></i> Create Second Admin</h2>
                    <div class="form-group">
                        <label class="form-label">User Name</label>
                        <input type="text" id="secondAdminUsername" class="form-input" placeholder="Enter username">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="secondAdminPassword" class="form-input" placeholder="Enter password">
                    </div>
                    <div class="form-group">
                        <label style="color: white; margin-right: 20px;">
                            <input type="radio" name="adminType" value="full" checked> Full Control
                        </label>
                        <label style="color: white;">
                            <input type="radio" name="adminType" value="read"> Only for Read
                        </label>
                    </div>
                    <button id="createSecondAdminBtn" class="submit-btn"><i class="fas fa-user-plus"></i> Create Second Admin</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Screen 4: Contact Links Screen -->
    <div id="screen4" class="screen">
        <div class="container">
            <div class="back-btn-container">
                <button id="backToScreen1FromContacts" class="back-btn"><i class="fas fa-arrow-left"></i> Back</button>
            </div>
            <div class="header">
                <h1 class="site-title">Kachin Visions Empire</h1>
                <div></div> <!-- Empty div for spacing -->
            </div>

            <div class="contact-links-screen">
                <h2 class="admin-title"><i class="fas fa-address-book"></i> Sumla Hkrung Dingsa Ni</h2>
                <div id="contactLinksScreenList">
                    <!-- Contact links will be displayed here in list format -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCJGR8dXeawpg6RNpF1iUC7TD65RWm-oxE",
            authDomain: "sun-day-video-production-298c8.firebaseapp.com",
            projectId: "sun-day-video-production-298c8",
            storageBucket: "sun-day-video-production-298c8.firebasestorage.app",
            messagingSenderId: "927333523323",
            appId: "1:927333523323:web:16375e95732c5acb4767de",
            measurementId: "G-ZY2Y2Y749H"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database();

        // DOM Elements
        const screens = document.querySelectorAll('.screen');
        const screen1 = document.getElementById('screen1');
        const screen2 = document.getElementById('screen2');
        const screen3 = document.getElementById('screen3');
        const screen4 = document.getElementById('screen4');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const loginModal = document.getElementById('loginModal');
        const closeModal = document.getElementById('closeModal');
        const loginBtn = document.getElementById('loginBtn');
        const loginMessage = document.getElementById('loginMessage');
        const backToScreen1 = document.getElementById('backToScreen1');
        const nextToScreen3 = document.getElementById('nextToScreen3');
        const backToScreen2 = document.getElementById('backToScreen2');
        const backToScreen1FromContacts = document.getElementById('backToScreen1FromContacts');
        const unlockVideosBtn = document.getElementById('unlockVideosBtn');
        const videoList = document.getElementById('videoList');
        const mainVideoPlayer = document.getElementById('mainVideoPlayer');
        const mainVideoElement = document.getElementById('mainVideoElement');
        const userList = document.getElementById('userList');
        const generatePasswordBtn = document.getElementById('generatePasswordBtn');
        const passwordCount = document.getElementById('passwordCount');
        const generatedPasswords = document.getElementById('generatedPasswords');
        const secondAdminSection = document.getElementById('secondAdminSection');
        const createSecondAdminBtn = document.getElementById('createSecondAdminBtn');
        const loginStatus = document.getElementById('loginStatus');
        const videoAdminList = document.getElementById('videoAdminList');
        const exportUnusedTxtBtn = document.getElementById('exportUnusedTxtBtn');
        const exportUnusedPdfBtn = document.getElementById('exportUnusedPdfBtn');
        const exportUsedTxtBtn = document.getElementById('exportUsedTxtBtn');
        const exportUsedPdfBtn = document.getElementById('exportUsedPdfBtn');
        const deleteUsedPasswordsBtn = document.getElementById('deleteUsedPasswordsBtn');
        const deleteUnusedPasswordsBtn = document.getElementById('deleteUnusedPasswordsBtn');
        const deleteAllPasswordsBtn = document.getElementById('deleteAllPasswordsBtn');
        const contactLinksScreenList = document.getElementById('contactLinksScreenList');
        const passwordSearch = document.getElementById('passwordSearch');
        const clearCacheBtn = document.getElementById('clearCacheBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const storageUsage = document.getElementById('storageUsage');
        const storageFill = document.getElementById('storageFill');
        const saveAdminMessage = document.getElementById('saveAdminMessage');
        const adminMessageContent = document.getElementById('adminMessageContent');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const textSelectionToolbar = document.getElementById('textSelectionToolbar');
        const saveVideoOrderBtn = document.getElementById('saveVideoOrderBtn');
        const noInternetModal = document.getElementById('noInternetModal');
        const continueOfflineBtn = document.getElementById('continueOfflineBtn');
        const showContactLinksScreen = document.getElementById('showContactLinksScreen');
        const qualitySelector = document.getElementById('qualitySelector');

        // PWA Install Prompt Elements
        const pwaInstallPrompt = document.getElementById('pwaInstallPrompt');
        const pwaInstallConfirm = document.getElementById('pwaInstallConfirm');
        const pwaInstallCancel = document.getElementById('pwaInstallCancel');

        // Rich Text Editor Elements
        const adminMessageEditor = document.getElementById('adminMessageEditor');
        const toolbarBtns = document.querySelectorAll('.toolbar-btn');
        const fontFamilySelect = document.getElementById('fontFamily');
        const fontSizeSelect = document.getElementById('fontSize');
        const textColorInput = document.getElementById('textColor');
        const backgroundColorInput = document.getElementById('backgroundColor');
        const previewMessageBtn = document.getElementById('previewMessage');
        
        // Custom Font Size Elements
        const customFontSize = document.getElementById('customFontSize');
        const applyCustomFontSize = document.getElementById('applyCustomFontSize');

        // Text Selection Toolbar Elements
        const selectionBtns = document.querySelectorAll('.selection-btn');
        const selectionTextColor = document.getElementById('selectionTextColor');
        const selectionBgColor = document.getElementById('selectionBgColor');
        const selectionFontSize = document.getElementById('selectionFontSize');
        const selectionFontFamily = document.getElementById('selectionFontFamily');

        // Video management elements
        const addCloudinaryBtn = document.getElementById('addCloudinaryBtn');
        const addYoutubeBtn = document.getElementById('addYoutubeBtn');
        const addTelegramBtn = document.getElementById('addTelegramBtn');
        const addHlsBtn = document.getElementById('addHlsBtn');
        const addInstagramBtn = document.getElementById('addInstagramBtn');
        const addTiktokBtn = document.getElementById('addTiktokBtn');
        const instagramUrl = document.getElementById('instagramUrl');
        const tiktokUrl = document.getElementById('tiktokUrl');

        // Password type selectors
        const cloudinaryPasswordType = document.getElementById('cloudinaryPasswordType');
        const youtubePasswordType = document.getElementById('youtubePasswordType');
        const telegramPasswordType = document.getElementById('telegramPasswordType');
        const hlsPasswordType = document.getElementById('hlsPasswordType');
        const instagramPasswordType = document.getElementById('instagramPasswordType');
        const tiktokPasswordType = document.getElementById('tiktokPasswordType');

        // NEW: Contact link management elements
        const addContactLinkBtn = document.getElementById('addContactLinkBtn');
        const contactLinkUrl = document.getElementById('contactLinkUrl');
        const contactLinkName = document.getElementById('contactLinkName');
        const contactLinkType = document.getElementById('contactLinkType');
        const contactLinkAccess = document.getElementById('contactLinkAccess');
        const contactLinksAdminList = document.getElementById('contactLinksAdminList');
        const saveContactLinksOrderBtn = document.getElementById('saveContactLinksOrderBtn');

        // Black bar configuration elements
        const topBarHeight = document.getElementById('topBarHeight');
        const bottomBarHeight = document.getElementById('bottomBarHeight');
        const applyTopBar = document.getElementById('applyTopBar');
        const applyBottomBar = document.getElementById('applyBottomBar');
        const applyToAllVideos = document.getElementById('applyToAllVideos');
        const resetBars = document.getElementById('resetBars');
        const topBlackBar = document.getElementById('topBlackBar');
        const bottomBlackBar = document.getElementById('bottomBlackBar');

        // State variables
        let currentUser = null;
        let isAdmin = false;
        let videos = [];
        let passwords = [];
        let currentDeviceId = '';
        let userSessionRef = null;
        let hls = null;
        let deferredPrompt = null;
        
        // NEW: Contact links data structure
        let contactLinksData = [];
        let contactLinksOrder = [];
        
        let currentVideoElement = null;
        let blackBarSettings = {
            top: 0,
            bottom: 0
        };
        let isUserLoggedIn = false;
        let videoOrder = []; // Array to store video IDs in order
        let isOfflineMode = false;

        // Admin message data structure
        let adminMessageData = {
            content: '',
            styles: {
                fontFamily: '',
                fontSize: '',
                textColor: '',
                backgroundColor: '',
                alignment: '',
                bold: false,
                italic: false,
                underline: false
            },
            timestamp: null
        };

        // Video preloading and caching
        let videoPreloadCache = new Map();
        let currentVideoQuality = 'auto';
        let videoCache = new Map(); // Cache for video elements

        // NEW: First play video settings
        let firstPlayVideoId = null;
        let autoPlayVideoOnStart = false;

        // Encryption key for offline storage
        const ENCRYPTION_KEY = 'kachin-visions-empire-encryption-key-2024';
        const DB_NAME = 'KachinVisionsDB';
        const DB_VERSION = 1;
        let dbInstance = null;

        // Create digital particles for background
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 50;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                // Random size between 2px and 6px
                const size = Math.random() * 4 + 2;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                
                // Random position
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 100}%`;
                
                // Random color from the theme
                const colors = [
                    'rgba(0, 245, 255, 0.5)',
                    'rgba(255, 0, 170, 0.5)',
                    'rgba(255, 85, 0, 0.5)',
                    'rgba(0, 255, 204, 0.5)'
                ];
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                
                // Random animation duration
                const duration = Math.random() * 20 + 10;
                particle.style.animationDuration = `${duration}s`;
                
                // Random animation delay
                const delay = Math.random() * 5;
                particle.style.animationDelay = `${delay}s`;
                
                particlesContainer.appendChild(particle);
            }
        }

        // PWA Install Prompt Handling
        function initPWAInstall() {
            // Listen for beforeinstallprompt event
            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevent the mini-infobar from appearing on mobile
                e.preventDefault();
                // Stash the event so it can be triggered later
                deferredPrompt = e;
                // Show the install prompt
                showInstallPrompt();
            });

            // Listen for app installed event
            window.addEventListener('appinstalled', () => {
                // Hide the install prompt
                hideInstallPrompt();
                // Log installation
                console.log('PWA was installed');
                
                // Send analytics if you have them
                if (window.gtag) {
                    gtag('event', 'install');
                }
            });

            // Check if app is already installed
            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
                console.log('App is already installed');
            }
        }

        function showInstallPrompt() {
            // Only show if not already installed and not shown recently
            const lastPrompt = localStorage.getItem('pwaPromptLastShown');
            const now = Date.now();
            
            if (lastPrompt && (now - lastPrompt) < 7 * 24 * 60 * 60 * 1000) {
                // Don't show more than once per week
                return;
            }
            
            pwaInstallPrompt.classList.remove('hidden');
            
            // Store that we've shown the prompt
            localStorage.setItem('pwaPromptLastShown', now.toString());
        }

        function hideInstallPrompt() {
            pwaInstallPrompt.classList.add('hidden');
        }

        // Generate device ID for this browser
        function generateDeviceId() {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        }

        // Initialize IndexedDB for offline storage
        function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    dbInstance = request.result;
                    resolve(dbInstance);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // Create object store for videos
                    if (!db.objectStoreNames.contains('videos')) {
                        const videoStore = db.createObjectStore('videos', { keyPath: 'id' });
                        videoStore.createIndex('name', 'name', { unique: false });
                        videoStore.createIndex('cached', 'cached', { unique: false });
                    }
                    
                    // Create object store for app data
                    if (!db.objectStoreNames.contains('appData')) {
                        const appStore = db.createObjectStore('appData', { keyPath: 'key' });
                    }
                    
                    // Create object store for proprietary video format
                    if (!db.objectStoreNames.contains('proprietaryVideos')) {
                        const proprietaryStore = db.createObjectStore('proprietaryVideos', { keyPath: 'id' });
                        proprietaryStore.createIndex('name', 'name', { unique: false });
                    }
                };
            });
        }

        // Preload videos for faster playback
        function preloadVideos() {
            // Only preload free videos or videos that are unlocked
            const videosToPreload = videos.filter(video => 
                video.passwordType === 'free' || isUserLoggedIn
            );
            
            // Limit preloading to first 5 videos to avoid excessive bandwidth usage
            const limitedVideos = videosToPreload.slice(0, 5);
            
            limitedVideos.forEach(video => {
                if (!videoPreloadCache.has(video.id) && 
                    video.type !== 'youtube' && 
                    video.type !== 'instagram' && 
                    video.type !== 'tiktok') {
                    
                    // Create a hidden video element to preload
                    const preloadVideo = document.createElement('video');
                    preloadVideo.style.display = 'none';
                    preloadVideo.preload = 'auto';
                    
                    const source = document.createElement('source');
                    source.src = video.url;
                    
                    // Set appropriate MIME type based on file extension
                    if (video.url.toLowerCase().endsWith('.webm')) {
                        source.type = 'video/webm';
                    } else if (video.url.toLowerCase().endsWith('.ogg') || video.url.toLowerCase().endsWith('.ogv')) {
                        source.type = 'video/ogg';
                    } else {
                        source.type = 'video/mp4'; // Default to MP4
                    }
                    
                    preloadVideo.appendChild(source);
                    document.body.appendChild(preloadVideo);
                    
                    // Store reference for later use
                    videoPreloadCache.set(video.id, preloadVideo);
                    
                    // Remove after a while to free memory
                    setTimeout(() => {
                        if (preloadVideo.parentNode) {
                            preloadVideo.parentNode.removeChild(preloadVideo);
                        }
                    }, 30000); // Remove after 30 seconds
                }
            });
        }

        // Auto-adjust video quality based on network speed
        function autoAdjustVideoQuality() {
            if (!navigator.onLine || isOfflineMode) {
                currentVideoQuality = 'low';
                return;
            }
            
            // Use Network Information API if available
            if (navigator.connection) {
                const connection = navigator.connection;
                const effectiveType = connection.effectiveType;
                const downlink = connection.downlink;
                
                if (effectiveType === '4g' && downlink > 5) {
                    currentVideoQuality = 'high';
                } else if (effectiveType === '4g' || (effectiveType === '3g' && downlink > 1.5)) {
                    currentVideoQuality = 'medium';
                } else {
                    currentVideoQuality = 'low';
                }
            } else {
                // Fallback: Use a simple timeout-based detection
                const startTime = Date.now();
                fetch('/ping', { method: 'HEAD', cache: 'no-cache' })
                    .then(() => {
                        const latency = Date.now() - startTime;
                        if (latency < 100) {
                            currentVideoQuality = 'high';
                        } else if (latency < 500) {
                            currentVideoQuality = 'medium';
                        } else {
                            currentVideoQuality = 'low';
                        }
                    })
                    .catch(() => {
                        currentVideoQuality = 'low';
                    });
            }
            
            // Update quality selector
            if (qualitySelector) {
                qualitySelector.value = currentVideoQuality;
            }
        }

        // Apply quality settings to video element
        function applyVideoQualitySettings(videoElement) {
            if (!videoElement) return;
            
            // For HLS streams, quality is handled by HLS.js
            if (hls && hls.levels && hls.levels.length > 0) {
                const levels = hls.levels;
                let targetLevel = -1; // Auto
                
                if (currentVideoQuality === 'low') {
                    // Find the lowest quality level
                    targetLevel = levels.reduce((minIndex, level, index) => {
                        return level.bitrate < levels[minIndex].bitrate ? index : minIndex;
                    }, 0);
                } else if (currentVideoQuality === 'high') {
                    // Find the highest quality level
                    targetLevel = levels.reduce((maxIndex, level, index) => {
                        return level.bitrate > levels[maxIndex].bitrate ? index : maxIndex;
                    }, 0);
                }
                
                if (targetLevel !== -1) {
                    hls.currentLevel = targetLevel;
                }
            }
            
            // For regular video elements, we can adjust playback rate for slower connections
            if (currentVideoQuality === 'low') {
                videoElement.playbackRate = 1.0; // Normal speed
            } else if (currentVideoQuality === 'medium') {
                videoElement.playbackRate = 1.0; // Normal speed
            } else {
                videoElement.playbackRate = 1.0; // Normal speed
            }
        }

        // Encrypt data for secure storage
        function encryptData(data) {
            try {
                const encrypted = CryptoJS.AES.encrypt(JSON.stringify(data), ENCRYPTION_KEY).toString();
                return encrypted;
            } catch (error) {
                console.error('Encryption error:', error);
                return data;
            }
        }

        // Decrypt data
        function decryptData(encryptedData) {
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedData, ENCRYPTION_KEY);
                const decrypted = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                return decrypted;
            } catch (error) {
                console.error('Decryption error:', error);
                return encryptedData;
            }
        }

        // Convert video to proprietary format
        async function convertToProprietaryFormat(videoBlob) {
            // Create a custom header for our proprietary format
            const header = {
                format: 'KACHIN_VISIONS_FORMAT',
                version: '1.0',
                timestamp: Date.now(),
                checksum: CryptoJS.MD5(ENCRYPTION_KEY + Date.now()).toString()
            };
            
            // Convert blob to array buffer
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const arrayBuffer = reader.result;
                    
                    // Combine header and video data
                    const headerString = JSON.stringify(header);
                    const headerBuffer = new TextEncoder().encode(headerString);
                    
                    // Create a new buffer with header length + header + video data
                    const headerLength = new Uint32Array([headerBuffer.length]);
                    const combinedBuffer = new Uint8Array(
                        headerLength.byteLength + headerBuffer.length + arrayBuffer.byteLength
                    );
                    
                    // Copy data to combined buffer
                    combinedBuffer.set(new Uint8Array(headerLength.buffer), 0);
                    combinedBuffer.set(headerBuffer, headerLength.byteLength);
                    combinedBuffer.set(new Uint8Array(arrayBuffer), headerLength.byteLength + headerBuffer.length);
                    
                    // Encrypt the combined buffer
                    const encrypted = encryptData(Array.from(combinedBuffer));
                    resolve(encrypted);
                };
                reader.readAsArrayBuffer(videoBlob);
            });
        }

        // Convert from proprietary format back to playable video
        async function convertFromProprietaryFormat(encryptedData) {
            try {
                // Decrypt the data
                const decrypted = decryptData(encryptedData);
                if (typeof decrypted === 'string') {
                    // Data is still encrypted, try to decrypt again
                    const bytes = CryptoJS.AES.decrypt(decrypted, ENCRYPTION_KEY);
                    const decryptedArray = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                    
                    // Convert back to Uint8Array
                    const combinedBuffer = new Uint8Array(decryptedArray);
                    
                    // Extract header length
                    const headerLength = new Uint32Array(combinedBuffer.buffer, 0, 1)[0];
                    
                    // Extract header
                    const headerBuffer = combinedBuffer.slice(4, 4 + headerLength);
                    const headerString = new TextDecoder().decode(headerBuffer);
                    const header = JSON.parse(headerString);
                    
                    // Verify header
                    if (header.format !== 'KACHIN_VISIONS_FORMAT') {
                        throw new Error('Invalid video format');
                    }
                    
                    // Extract video data
                    const videoBuffer = combinedBuffer.slice(4 + headerLength);
                    
                    // Convert to blob
                    return new Blob([videoBuffer], { type: 'video/mp4' });
                } else {
                    // Data is already decrypted array
                    const combinedBuffer = new Uint8Array(decrypted);
                    
                    // Extract header length
                    const headerLength = new Uint32Array(combinedBuffer.buffer, 0, 1)[0];
                    
                    // Extract header
                    const headerBuffer = combinedBuffer.slice(4, 4 + headerLength);
                    const headerString = new TextDecoder().decode(headerBuffer);
                    const header = JSON.parse(headerString);
                    
                    // Verify header
                    if (header.format !== 'KACHIN_VISIONS_FORMAT') {
                        throw new Error('Invalid video format');
                    }
                    
                    // Extract video data
                    const videoBuffer = combinedBuffer.slice(4 + headerLength);
                    
                    // Convert to blob
                    return new Blob([videoBuffer], { type: 'video/mp4' });
                }
            } catch (error) {
                console.error('Error converting from proprietary format:', error);
                throw error;
            }
        }

        // Store video in offline storage with proprietary format
        async function cacheVideo(video) {
            if (!dbInstance) return;
            
            return new Promise((resolve, reject) => {
                const transaction = dbInstance.transaction(['videos', 'proprietaryVideos'], 'readwrite');
                const store = transaction.objectStore('videos');
                const proprietaryStore = transaction.objectStore('proprietaryVideos');
                
                // Check if video is already cached
                const getRequest = store.get(video.id);
                
                getRequest.onsuccess = () => {
                    if (!getRequest.result) {
                        // Fetch and cache the video
                        fetch(video.url)
                            .then(response => response.blob())
                            .then(blob => {
                                // Convert to proprietary format
                                convertToProprietaryFormat(blob)
                                    .then(proprietaryData => {
                                        const videoData = {
                                            id: video.id,
                                            name: video.name,
                                            type: video.type,
                                            url: video.url,
                                            cached: true,
                                            proprietaryData: proprietaryData,
                                            timestamp: Date.now()
                                        };
                                        
                                        const putRequest = store.put(videoData);
                                        putRequest.onsuccess = () => {
                                            console.log(`Video ${video.name} cached in proprietary format`);
                                            resolve(true);
                                        };
                                        putRequest.onerror = () => reject(putRequest.error);
                                    })
                                    .catch(error => {
                                        console.error('Error converting to proprietary format:', error);
                                        reject(error);
                                    });
                            })
                            .catch(error => {
                                console.error('Error caching video:', error);
                                reject(error);
                            });
                    } else {
                        resolve(true);
                    }
                };
                
                getRequest.onerror = () => reject(getRequest.error);
            });
        }

        // Get cached video in proprietary format
        async function getCachedVideo(videoId) {
            if (!dbInstance) return null;
            
            return new Promise((resolve, reject) => {
                const transaction = dbInstance.transaction(['videos'], 'readonly');
                const store = transaction.objectStore('videos');
                const request = store.get(videoId);
                
                request.onsuccess = () => {
                    if (request.result && request.result.proprietaryData) {
                        // Convert from proprietary format back to playable video
                        convertFromProprietaryFormat(request.result.proprietaryData)
                            .then(videoBlob => {
                                const videoUrl = URL.createObjectURL(videoBlob);
                                resolve(videoUrl);
                            })
                            .catch(error => {
                                console.error('Error converting from proprietary format:', error);
                                reject(error);
                            });
                    } else {
                        resolve(null);
                    }
                };
                
                request.onerror = () => reject(request.error);
            });
        }

        // Calculate storage usage
        async function calculateStorageUsage() {
            if (!dbInstance) return 0;
            
            return new Promise((resolve, reject) => {
                const transaction = dbInstance.transaction(['videos'], 'readonly');
                const store = transaction.objectStore('videos');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    let totalSize = 0;
                    request.result.forEach(video => {
                        if (video.proprietaryData) {
                            // Approximate size from encrypted data
                            totalSize += video.proprietaryData.length;
                        }
                    });
                    resolve(totalSize);
                };
                
                request.onerror = () => reject(request.error);
            });
        }

        // Update storage display
        async function updateStorageDisplay() {
            const sizeInBytes = await calculateStorageUsage();
            const sizeInMB = (sizeInBytes / (1024 * 1024)).toFixed(2);
            const percentage = Math.min((sizeInBytes / (50 * 1024 * 1024)) * 100, 100); // 50MB limit
            
            storageUsage.textContent = `${sizeInMB} MB`;
            storageFill.style.width = `${percentage}%`;
            
            // Change color based on usage
            if (percentage > 80) {
                storageFill.style.background = 'linear-gradient(135deg, var(--danger), #cc0000)';
            } else if (percentage > 60) {
                storageFill.style.background = 'linear-gradient(135deg, var(--warning), #e6b400)';
            } else {
                storageFill.style.background = 'linear-gradient(135deg, var(--success), #00ccaa)';
            }
        }

        // Clear all cached data
        async function clearCache() {
            if (!dbInstance) return;
            
            if (confirm('Are you sure you want to clear all offline videos? This cannot be undone.')) {
                // Clear IndexedDB
                const transaction = dbInstance.transaction(['videos', 'proprietaryVideos'], 'readwrite');
                const store = transaction.objectStore('videos');
                const proprietaryStore = transaction.objectStore('proprietaryVideos');
                
                const clearRequest = store.clear();
                const clearProprietaryRequest = proprietaryStore.clear();
                
                clearRequest.onsuccess = () => {
                    clearProprietaryRequest.onsuccess = () => {
                        alert('Offline cache cleared successfully!');
                        updateStorageDisplay();
                        renderVideoList();
                    };
                };
                
                clearRequest.onerror = () => {
                    alert('Error clearing cache. Please try again.');
                };
            }
        }

        // Monitor online/offline status
        function monitorConnection() {
            function updateConnectionStatus() {
                if (navigator.onLine) {
                    connectionStatus.textContent = 'Online';
                    connectionStatus.className = 'connection-status online-status-badge';
                    connectionStatus.style.display = 'flex';
                    
                    // Hide no internet modal if shown
                    noInternetModal.style.display = 'none';
                    isOfflineMode = false;
                    
                    // Reconnect to Firebase when online
                    if (firebase.apps.length > 0) {
                        // Firebase automatically reconnects, but we can trigger a refresh
                        loadVideos();
                        loadPasswords();
                        loadContactLinks();
                        loadAdminMessage();
                    }
                    
                    // Hide after 3 seconds
                    setTimeout(() => {
                        connectionStatus.style.display = 'none';
                    }, 3000);
                } else {
                    connectionStatus.textContent = 'Offline';
                    connectionStatus.className = 'connection-status offline-status-badge';
                    connectionStatus.style.display = 'flex';
                    
                    // Show no internet modal if not already in offline mode
                    if (!isOfflineMode) {
                        noInternetModal.style.display = 'flex';
                    }
                }
            }

            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);
            updateConnectionStatus();
        }

        // Continue in offline mode
        function continueOffline() {
            noInternetModal.style.display = 'none';
            isOfflineMode = true;
            
            // Load offline data
            loadVideosFromOffline();
            loadPasswordsOffline();
            loadContactLinksOffline();
            loadAdminMessageOffline();
            
            alert('Continuing in offline mode. Some features may be limited.');
        }

        // Load admin message from Firebase
        function loadAdminMessage() {
            // Try to load from Firebase first
            if (navigator.onLine && !isOfflineMode) {
                db.collection('settings').doc('adminMessage').get().then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        adminMessageData = data;
                        
                        // Save to offline storage
                        saveAdminMessageOffline(data);
                        
                        // Render the admin message
                        renderAdminMessage();
                        
                        // Load into editor if admin
                        if (isAdmin) {
                            loadAdminMessageToEditor();
                        }
                    } else {
                        // No admin message exists yet
                        loadAdminMessageOffline();
                    }
                }).catch(error => {
                    console.error('Error loading admin message from Firebase:', error);
                    // Fall back to offline storage
                    loadAdminMessageOffline();
                });
            } else {
                // Offline mode - load from local storage
                loadAdminMessageOffline();
            }
        }

        // Save admin message to offline storage
        function saveAdminMessageOffline(data) {
            if (!dbInstance) return;
            
            const transaction = dbInstance.transaction(['appData'], 'readwrite');
            const store = transaction.objectStore('appData');
            store.put({
                key: 'adminMessage',
                data: data
            });
        }

        // Load admin message from offline storage
        function loadAdminMessageOffline() {
            if (!dbInstance) {
                adminMessageContent.textContent = 'No message from admin yet.';
                return;
            }
            
            const transaction = dbInstance.transaction(['appData'], 'readonly');
            const store = transaction.objectStore('appData');
            const request = store.get('adminMessage');
            
            request.onsuccess = () => {
                if (request.result) {
                    adminMessageData = request.result.data;
                    renderAdminMessage();
                    
                    if (isAdmin) {
                        loadAdminMessageToEditor();
                    }
                } else {
                    adminMessageContent.textContent = 'No message from admin yet.';
                }
            };
            
            request.onerror = () => {
                adminMessageContent.textContent = 'No message from admin yet.';
            };
        }

        // Load admin message into the rich text editor
        function loadAdminMessageToEditor() {
            if (adminMessageData.content) {
                adminMessageEditor.innerHTML = adminMessageData.content;
                
                // Apply styles if they exist
                if (adminMessageData.styles) {
                    applyStylesToEditor(adminMessageData.styles);
                }
            } else {
                adminMessageEditor.innerHTML = '';
            }
        }

        // Apply styles to the rich text editor
        function applyStylesToEditor(styles) {
            // Set font family
            if (styles.fontFamily) {
                adminMessageEditor.style.fontFamily = styles.fontFamily;
                fontFamilySelect.value = styles.fontFamily;
            }
            
            // Set font size
            if (styles.fontSize) {
                adminMessageEditor.style.fontSize = styles.fontSize;
                fontSizeSelect.value = styles.fontSize;
            }
            
            // Set text color
            if (styles.textColor) {
                adminMessageEditor.style.color = styles.textColor;
                textColorInput.value = styles.textColor;
            }
            
            // Set background color
            if (styles.backgroundColor) {
                adminMessageEditor.style.backgroundColor = styles.backgroundColor;
                backgroundColorInput.value = styles.backgroundColor;
            }
            
            // Set alignment
            if (styles.alignment) {
                adminMessageEditor.style.textAlign = styles.alignment;
            }
        }

        // Render admin message on the main screen
        function renderAdminMessage() {
            if (adminMessageData.content) {
                adminMessageContent.innerHTML = adminMessageData.content;
                
                // Apply styles to the displayed message
                if (adminMessageData.styles) {
                    applyStylesToMessage(adminMessageData.styles);
                }
            } else {
                adminMessageContent.textContent = 'No message from admin yet.';
            }
        }

        // Apply styles to the displayed admin message
        function applyStylesToMessage(styles) {
            // Set font family
            if (styles.fontFamily) {
                adminMessageContent.style.fontFamily = styles.fontFamily;
            }
            
            // Set font size
            if (styles.fontSize) {
                adminMessageContent.style.fontSize = styles.fontSize;
            }
            
            // Set text color
            if (styles.textColor) {
                adminMessageContent.style.color = styles.textColor;
            }
            
            // Set background color
            if (styles.backgroundColor) {
                adminMessageContent.style.backgroundColor = styles.backgroundColor;
            }
            
            // Set alignment
            if (styles.alignment) {
                adminMessageContent.style.textAlign = styles.alignment;
            }
            
            // Set font weight
            if (styles.bold) {
                adminMessageContent.style.fontWeight = 'bold';
            }
            
            // Set font style
            if (styles.italic) {
                adminMessageContent.style.fontStyle = 'italic';
            }
            
            // Set text decoration
            if (styles.underline) {
                adminMessageContent.style.textDecoration = 'underline';
            }
        }

        // Save admin message to Firebase
        function saveAdminMessageData() {
            // Get content from editor
            const content = adminMessageEditor.innerHTML;
            
            // Get current styles
            const styles = {
                fontFamily: adminMessageEditor.style.fontFamily || '',
                fontSize: adminMessageEditor.style.fontSize || '',
                textColor: adminMessageEditor.style.color || '',
                backgroundColor: adminMessageEditor.style.backgroundColor || '',
                alignment: adminMessageEditor.style.textAlign || '',
                bold: adminMessageEditor.style.fontWeight === 'bold',
                italic: adminMessageEditor.style.fontStyle === 'italic',
                underline: adminMessageEditor.style.textDecoration === 'underline'
            };
            
            // Update admin message data
            adminMessageData = {
                content: content,
                styles: styles,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Save to Firebase if online
            if (navigator.onLine && !isOfflineMode) {
                db.collection('settings').doc('adminMessage').set(adminMessageData)
                .then(() => {
                    alert('Admin message saved successfully!');
                    
                    // Save to offline storage
                    saveAdminMessageOffline(adminMessageData);
                    
                    // Update the displayed message
                    renderAdminMessage();
                })
                .catch(error => {
                    console.error('Error saving admin message:', error);
                    alert('Error saving admin message. Please try again.');
                });
            } else {
                // Save to offline storage only
                saveAdminMessageOffline(adminMessageData);
                alert('Admin message saved for offline use. Will sync when online.');
                
                // Update the displayed message
                renderAdminMessage();
            }
        }

        // Initialize rich text editor functionality
        function initRichTextEditor() {
            // Toolbar button click handlers
            toolbarBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const command = btn.getAttribute('data-command');
                    
                    if (command) {
                        document.execCommand(command, false, null);
                        adminMessageEditor.focus();
                        
                        // Update active state for formatting buttons
                        if (['bold', 'italic', 'underline'].includes(command)) {
                            btn.classList.toggle('active');
                        }
                    }
                });
            });
            
            // Font family change handler
            fontFamilySelect.addEventListener('change', () => {
                const fontFamily = fontFamilySelect.value;
                if (fontFamily) {
                    document.execCommand('fontName', false, fontFamily);
                    adminMessageEditor.style.fontFamily = fontFamily;
                    adminMessageEditor.focus();
                }
            });
            
            // Font size change handler
            fontSizeSelect.addEventListener('change', () => {
                const fontSize = fontSizeSelect.value;
                if (fontSize) {
                    document.execCommand('fontSize', false, fontSize);
                    
                    // Map font size values to actual sizes
                    const sizeMap = {
                        '12px': '12px',
                        '14px': '14px',
                        '16px': '16px',
                        '18px': '18px',
                        '20px': '20px',
                        '24px': '24px'
                    };
                    
                    adminMessageEditor.style.fontSize = sizeMap[fontSize] || '14px';
                    adminMessageEditor.focus();
                }
            });
            
            // Custom font size handler
            applyCustomFontSize.addEventListener('click', () => {
                const fontSize = customFontSize.value;
                if (fontSize && fontSize >= 1 && fontSize <= 100) {
                    document.execCommand('fontSize', false, fontSize);
                    adminMessageEditor.style.fontSize = fontSize + 'px';
                    adminMessageEditor.focus();
                } else {
                    alert('Please enter a valid font size between 1 and 100');
                }
            });
            
            // Text color change handler
            textColorInput.addEventListener('change', () => {
                const color = textColorInput.value;
                document.execCommand('foreColor', false, color);
                adminMessageEditor.style.color = color;
                adminMessageEditor.focus();
            });
            
            // Background color change handler
            backgroundColorInput.addEventListener('change', () => {
                const color = backgroundColorInput.value;
                document.execCommand('hiliteColor', false, color);
                adminMessageEditor.style.backgroundColor = color;
                adminMessageEditor.focus();
            });
            
            // Preview message handler
            previewMessageBtn.addEventListener('click', () => {
                const content = adminMessageEditor.innerHTML;
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                
                // Apply current editor styles to preview
                tempDiv.style.fontFamily = adminMessageEditor.style.fontFamily;
                tempDiv.style.fontSize = adminMessageEditor.style.fontSize;
                tempDiv.style.color = adminMessageEditor.style.color;
                tempDiv.style.backgroundColor = adminMessageEditor.style.backgroundColor;
                tempDiv.style.textAlign = adminMessageEditor.style.textAlign;
                tempDiv.style.padding = '15px';
                tempDiv.style.borderRadius = '8px';
                tempDiv.style.background = adminMessageEditor.style.backgroundColor || 'rgba(255, 255, 255, 0.1)';
                
                alert('Preview of your message:\n\n' + tempDiv.textContent);
            });
            
            // Handle editor focus to update toolbar states
            adminMessageEditor.addEventListener('input', () => {
                updateToolbarStates();
            });
            
            adminMessageEditor.addEventListener('focus', () => {
                updateToolbarStates();
            });
            
            // Initialize text selection functionality
            initTextSelection();
        }
        
        // Initialize text selection functionality
        function initTextSelection() {
            // Add text selection event listeners to admin message content
            adminMessageContent.addEventListener('mouseup', showTextSelectionToolbar);
            adminMessageEditor.addEventListener('mouseup', showTextSelectionToolbar);
            
            // Add event listeners for selection toolbar buttons
            selectionBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const command = btn.getAttribute('data-command');
                    
                    if (command) {
                        document.execCommand(command, false, null);
                        hideTextSelectionToolbar();
                    }
                });
            });
            
            // Text color change handler for selection toolbar
            selectionTextColor.addEventListener('change', () => {
                const color = selectionTextColor.value;
                document.execCommand('foreColor', false, color);
                hideTextSelectionToolbar();
            });
            
            // Background color change handler for selection toolbar
            selectionBgColor.addEventListener('change', () => {
                const color = selectionBgColor.value;
                document.execCommand('hiliteColor', false, color);
                hideTextSelectionToolbar();
            });
            
            // Font size change handler for selection toolbar
            selectionFontSize.addEventListener('change', () => {
                const fontSize = selectionFontSize.value;
                if (fontSize) {
                    document.execCommand('fontSize', false, fontSize);
                    hideTextSelectionToolbar();
                }
            });
            
            // Font family change handler for selection toolbar
            selectionFontFamily.addEventListener('change', () => {
                const fontFamily = selectionFontFamily.value;
                if (fontFamily) {
                    document.execCommand('fontName', false, fontFamily);
                    hideTextSelectionToolbar();
                }
            });
            
            // Hide selection toolbar when clicking elsewhere
            document.addEventListener('mousedown', (e) => {
                if (!textSelectionToolbar.contains(e.target) && 
                    !adminMessageContent.contains(e.target) && 
                    !adminMessageEditor.contains(e.target)) {
                    hideTextSelectionToolbar();
                }
            });
        }
        
        // Show text selection toolbar
        function showTextSelectionToolbar(e) {
            const selection = window.getSelection();
            if (selection.toString().length > 0) {
                // Position the toolbar near the selection
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                
                textSelectionToolbar.style.display = 'flex';
                textSelectionToolbar.style.top = (rect.top - 50) + 'px';
                textSelectionToolbar.style.left = (rect.left + (rect.width / 2) - 150) + 'px';
            }
        }
        
        // Hide text selection toolbar
        function hideTextSelectionToolbar() {
            textSelectionToolbar.style.display = 'none';
        }
        
        // Update toolbar button states based on current selection
        function updateToolbarStates() {
            toolbarBtns.forEach(btn => {
                const command = btn.getAttribute('data-command');
                if (['bold', 'italic', 'underline'].includes(command)) {
                    const isActive = document.queryCommandState(command);
                    btn.classList.toggle('active', isActive);
                }
            });
        }

        // Apply black bars to video player
        function applyBlackBars() {
            topBlackBar.style.height = blackBarSettings.top + 'px';
            bottomBlackBar.style.height = blackBarSettings.bottom + 'px';
            
            // Update the video content area to account for the bars
            const videoContent = document.querySelector('.video-content');
            if (videoContent) {
                const totalBarHeight = blackBarSettings.top + blackBarSettings.bottom;
                videoContent.style.height = `calc(100% - ${totalBarHeight}px)`;
            }
        }

        // Save black bar settings to Firebase
        function saveBlackBarSettings() {
            if (navigator.onLine && !isOfflineMode) {
                db.collection('settings').doc('blackBarSettings').set(blackBarSettings)
                .then(() => {
                    console.log('Black bar settings saved to Firebase');
                })
                .catch(error => {
                    console.error('Error saving black bar settings:', error);
                });
            }
            
            // Save to local storage for offline use
            localStorage.setItem('blackBarSettings', JSON.stringify(blackBarSettings));
        }

        // Load black bar settings
        function loadBlackBarSettings() {
            // Try to load from Firebase first
            if (navigator.onLine && !isOfflineMode) {
                db.collection('settings').doc('blackBarSettings').get().then(doc => {
                    if (doc.exists) {
                        blackBarSettings = doc.data();
                        applyBlackBars();
                        
                        // Update input fields
                        topBarHeight.value = blackBarSettings.top;
                        bottomBarHeight.value = blackBarSettings.bottom;
                        
                        // Save to local storage
                        localStorage.setItem('blackBarSettings', JSON.stringify(blackBarSettings));
                    } else {
                        // No settings exist yet, try local storage
                        loadBlackBarSettingsFromLocal();
                    }
                }).catch(error => {
                    console.error('Error loading black bar settings from Firebase:', error);
                    // Fall back to local storage
                    loadBlackBarSettingsFromLocal();
                });
            } else {
                // Offline mode - load from local storage
                loadBlackBarSettingsFromLocal();
            }
        }

        // Load black bar settings from local storage
        function loadBlackBarSettingsFromLocal() {
            const savedSettings = localStorage.getItem('blackBarSettings');
            if (savedSettings) {
                blackBarSettings = JSON.parse(savedSettings);
                applyBlackBars();
                
                // Update input fields
                topBarHeight.value = blackBarSettings.top;
                bottomBarHeight.value = blackBarSettings.bottom;
            }
        }

        // Load video order from Firebase
        function loadVideoOrder() {
            // Try to load from Firebase first
            if (navigator.onLine && !isOfflineMode) {
                db.collection('settings').doc('videoOrder').get().then(doc => {
                    if (doc.exists) {
                        videoOrder = doc.data().order || [];
                        console.log('Video order loaded from Firebase:', videoOrder);
                        
                        // Save to offline storage
                        saveVideoOrderOffline(videoOrder);
                        
                        // Re-render video lists with the correct order
                        renderVideoList();
                        renderAdminVideoList();
                    } else {
                        // No video order exists yet, create default order
                        createDefaultVideoOrder();
                    }
                }).catch(error => {
                    console.error('Error loading video order from Firebase:', error);
                    // Fall back to offline storage
                    loadVideoOrderOffline();
                });
            } else {
                // Offline mode - load from local storage
                loadVideoOrderOffline();
            }
        }

        // Save video order to offline storage
        function saveVideoOrderOffline(order) {
            if (!dbInstance) return;
            
            const transaction = dbInstance.transaction(['appData'], 'readwrite');
            const store = transaction.objectStore('appData');
            store.put({
                key: 'videoOrder',
                data: order
            });
        }

        // Load video order from offline storage
        function loadVideoOrderOffline() {
            if (!dbInstance) {
                createDefaultVideoOrder();
                return;
            }
            
            const transaction = dbInstance.transaction(['appData'], 'readonly');
            const store = transaction.objectStore('appData');
            const request = store.get('videoOrder');
            
            request.onsuccess = () => {
                if (request.result) {
                    videoOrder = request.result.data;
                    console.log('Video order loaded from offline storage:', videoOrder);
                    
                    // Re-render video lists with the correct order
                    renderVideoList();
                    renderAdminVideoList();
                } else {
                    // No video order in offline storage, create default
                    createDefaultVideoOrder();
                }
            };
            
            request.onerror = () => {
                createDefaultVideoOrder();
            };
        }

        // Create default video order based on current videos
        function createDefaultVideoOrder() {
            videoOrder = videos.map(video => video.id);
            console.log('Created default video order:', videoOrder);
            
            // Save to Firebase if online
            if (navigator.onLine && !isOfflineMode) {
                saveVideoOrderToFirebase();
            }
            
            // Save to offline storage
            saveVideoOrderOffline(videoOrder);
        }

        // Save video order to Firebase
        function saveVideoOrderToFirebase() {
            if (navigator.onLine && !isOfflineMode) {
                db.collection('settings').doc('videoOrder').set({
                    order: videoOrder,
                    updated: firebase.firestore.FieldValue.serverTimestamp()
                })
                .then(() => {
                    console.log('Video order saved to Firebase');
                })
                .catch(error => {
                    console.error('Error saving video order to Firebase:', error);
                });
            }
        }

        // Sort videos according to the saved order
        function sortVideosByOrder() {
            if (videoOrder.length === 0) {
                return videos;
            }
            
            // Create a map for quick lookup
            const videoMap = {};
            videos.forEach(video => {
                videoMap[video.id] = video;
            });
            
            // Sort videos according to the order array
            const sortedVideos = [];
            videoOrder.forEach(id => {
                if (videoMap[id]) {
                    sortedVideos.push(videoMap[id]);
                    delete videoMap[id];
                }
            });
            
            // Add any remaining videos that aren't in the order array
            Object.values(videoMap).forEach(video => {
                sortedVideos.push(video);
                videoOrder.push(video.id); // Add to order for next time
            });
            
            return sortedVideos;
        }

        // Save video order when admin reorders videos
        function saveVideoOrder() {
            // Get the current order from the DOM
            const videoItems = Array.from(videoAdminList.querySelectorAll('.video-admin-item'));
            const newOrder = videoItems.map(item => item.getAttribute('data-id'));
            
            videoOrder = newOrder;
            
            // Save to Firebase if online
            if (navigator.onLine && !isOfflineMode) {
                saveVideoOrderToFirebase();
                alert('Video order saved successfully!');
            } else {
                // Save to offline storage only
                saveVideoOrderOffline(videoOrder);
                alert('Video order saved for offline use. Will sync when online.');
            }
            
            // Update the user-facing video list
            renderVideoList();
        }

        // Initialize drag and drop for video reordering
        function initVideoReordering() {
            const videoAdminList = document.getElementById('videoAdminList');
            
            if (!videoAdminList) return;
            
            let draggedItem = null;
            
            // Add event listeners for drag and drop
            videoAdminList.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('video-admin-item')) {
                    draggedItem = e.target;
                    e.target.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', e.target.outerHTML);
                }
            });
            
            videoAdminList.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(videoAdminList, e.clientY);
                const draggable = document.querySelector('.dragging');
                
                if (draggable) {
                    if (afterElement == null) {
                        videoAdminList.appendChild(draggable);
                    } else {
                        videoAdminList.insertBefore(draggable, afterElement);
                    }
                }
            });
            
            videoAdminList.addEventListener('dragend', (e) => {
                if (e.target.classList.contains('video-admin-item')) {
                    e.target.classList.remove('dragging');
                    draggedItem = null;
                    
                    // Remove drag-over class from all items
                    document.querySelectorAll('.video-admin-item').forEach(item => {
                        item.classList.remove('drag-over');
                    });
                }
            });
            
            // Helper function to determine where to place the dragged item
            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.video-admin-item:not(.dragging)')];
                
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }
        }

        // NEW: Load contact links from Firebase
        function loadContactLinks() {
            // Try to load from Firebase first
            if (navigator.onLine && !isOfflineMode) {
                db.collection('contactLinks').get().then(snapshot => {
                    contactLinksData = [];
                    snapshot.forEach(doc => {
                        contactLinksData.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Load contact links order
                    loadContactLinksOrder();
                    
                    // Save to offline storage
                    saveContactLinksOffline(contactLinksData);
                    
                    // Render contact links screen
                    renderContactLinksScreen();
                    
                    // Render admin contact links list
                    renderAdminContactLinksList();
                }).catch(error => {
                    console.error('Error loading contact links:', error);
                    // Fall back to offline storage
                    loadContactLinksOffline();
                });
            } else {
                // Offline mode - load from local storage
                loadContactLinksOffline();
            }
        }

        // NEW: Save contact links to offline storage
        function saveContactLinksOffline(linksData) {
            if (!dbInstance) return;
            
            const transaction = dbInstance.transaction(['appData'], 'readwrite');
            const store = transaction.objectStore('appData');
            store.put({
                key: 'contactLinks',
                data: linksData
            });
        }

        // NEW: Load contact links from offline storage
        function loadContactLinksOffline() {
            if (!dbInstance) {
                renderContactLinksScreen();
                return;
            }
            
            const transaction = dbInstance.transaction(['appData'], 'readonly');
            const store = transaction.objectStore('appData');
            const request = store.get('contactLinks');
            
            request.onsuccess = () => {
                if (request.result) {
                    contactLinksData = request.result.data;
                    
                    // Load contact links order from offline storage
                    loadContactLinksOrderOffline();
                    
                    // Render contact links screen
                    renderContactLinksScreen();
                    
                    // Render admin contact links list
                    renderAdminContactLinksList();
                } else {
                    // No contact links in offline storage
                    renderContactLinksScreen();
                }
            };
            
            request.onerror = () => {
                renderContactLinksScreen();
            };
        }

        // NEW: Load contact links order from Firebase
        function loadContactLinksOrder() {
            // Try to load from Firebase first
            if (navigator.onLine && !isOfflineMode) {
                db.collection('settings').doc('contactLinksOrder').get().then(doc => {
                    if (doc.exists) {
                        contactLinksOrder = doc.data().order || [];
                        console.log('Contact links order loaded from Firebase:', contactLinksOrder);
                        
                        // Save to offline storage
                        saveContactLinksOrderOffline(contactLinksOrder);
                        
                        // Re-render contact links with the correct order
                        renderContactLinksScreen();
                        renderAdminContactLinksList();
                    } else {
                        // No contact links order exists yet, create default order
                        createDefaultContactLinksOrder();
                    }
                }).catch(error => {
                    console.error('Error loading contact links order from Firebase:', error);
                    // Fall back to offline storage
                    loadContactLinksOrderOffline();
                });
            } else {
                // Offline mode - load from local storage
                loadContactLinksOrderOffline();
            }
        }

        // NEW: Save contact links order to offline storage
        function saveContactLinksOrderOffline(order) {
            if (!dbInstance) return;
            
            const transaction = dbInstance.transaction(['appData'], 'readwrite');
            const store = transaction.objectStore('appData');
            store.put({
                key: 'contactLinksOrder',
                data: order
            });
        }

        // NEW: Load contact links order from offline storage
        function loadContactLinksOrderOffline() {
            if (!dbInstance) {
                createDefaultContactLinksOrder();
                return;
            }
            
            const transaction = dbInstance.transaction(['appData'], 'readonly');
            const store = transaction.objectStore('appData');
            const request = store.get('contactLinksOrder');
            
            request.onsuccess = () => {
                if (request.result) {
                    contactLinksOrder = request.result.data;
                    console.log('Contact links order loaded from offline storage:', contactLinksOrder);
                    
                    // Re-render contact links with the correct order
                    renderContactLinksScreen();
                    renderAdminContactLinksList();
                } else {
                    // No contact links order in offline storage, create default
                    createDefaultContactLinksOrder();
                }
            };
            
            request.onerror = () => {
                createDefaultContactLinksOrder();
            };
        }

        // NEW: Create default contact links order based on current links
        function createDefaultContactLinksOrder() {
            contactLinksOrder = contactLinksData.map(link => link.id);
            console.log('Created default contact links order:', contactLinksOrder);
            
            // Save to Firebase if online
            if (navigator.onLine && !isOfflineMode) {
                saveContactLinksOrderToFirebase();
            }
            
            // Save to offline storage
            saveContactLinksOrderOffline(contactLinksOrder);
        }

        // NEW: Save contact links order to Firebase
        function saveContactLinksOrderToFirebase() {
            if (navigator.onLine && !isOfflineMode) {
                db.collection('settings').doc('contactLinksOrder').set({
                    order: contactLinksOrder,
                    updated: firebase.firestore.FieldValue.serverTimestamp()
                })
                .then(() => {
                    console.log('Contact links order saved to Firebase');
                })
                .catch(error => {
                    console.error('Error saving contact links order to Firebase:', error);
                });
            }
        }

        // NEW: Sort contact links according to the saved order
        function sortContactLinksByOrder() {
            if (contactLinksOrder.length === 0) {
                return contactLinksData;
            }
            
            // Create a map for quick lookup
            const linkMap = {};
            contactLinksData.forEach(link => {
                linkMap[link.id] = link;
            });
            
            // Sort links according to the order array
            const sortedLinks = [];
            contactLinksOrder.forEach(id => {
                if (linkMap[id]) {
                    sortedLinks.push(linkMap[id]);
                    delete linkMap[id];
                }
            });
            
            // Add any remaining links that aren't in the order array
            Object.values(linkMap).forEach(link => {
                sortedLinks.push(link);
                contactLinksOrder.push(link.id); // Add to order for next time
            });
            
            return sortedLinks;
        }

        // NEW: Render contact links screen with list format
        function renderContactLinksScreen() {
            contactLinksScreenList.innerHTML = '';
            
            // Sort links according to saved order
            const sortedLinks = sortContactLinksByOrder();
            
            sortedLinks.forEach(link => {
                // Check if link is free or requires password
                if (link.accessType === 'free' || isUserLoggedIn) {
                    const linkItem = document.createElement('div');
                    linkItem.className = 'contact-link-screen-item';
                    
                    // Set appropriate icon based on link type
                    let icon = '';
                    let btnClass = 'contact-link-screen-btn ';
                    switch(link.type) {
                        case 'facebook':
                            icon = '<i class="fab fa-facebook-f"></i>';
                            btnClass += 'facebook-screen-btn';
                            break;
                        case 'telegram':
                            icon = '<i class="fab fa-telegram"></i>';
                            btnClass += 'telegram-screen-btn';
                            break;
                        case 'viber':
                            icon = '<i class="fab fa-viber"></i>';
                            btnClass += 'viber-screen-btn';
                            break;
                        default:
                            icon = '<i class="fas fa-link"></i>';
                            btnClass += 'other-screen-btn';
                    }
                    
                    linkItem.innerHTML = `
                        <div class="contact-link-screen-icon">${icon}</div>
                        <div class="contact-link-screen-info">
                            <div class="contact-link-screen-name">${link.name}</div>
                            <div class="contact-link-screen-type">${link.type.charAt(0).toUpperCase() + link.type.slice(1)}</div>
                        </div>
                        <a href="${link.url}" target="_blank" class="${btnClass}"><i class="fas fa-external-link-alt"></i> Open</a>
                    `;
                    
                    contactLinksScreenList.appendChild(linkItem);
                }
            });
        }

        // NEW: Render admin contact links list with edit/delete options and reordering
        function renderAdminContactLinksList() {
            contactLinksAdminList.innerHTML = '';
            
            // Sort links according to saved order
            const sortedLinks = sortContactLinksByOrder();
            
            sortedLinks.forEach((link, index) => {
                const linkItem = document.createElement('div');
                linkItem.className = `contact-link-item ${link.accessType === 'free' ? 'free' : 'password-protected'}`;
                linkItem.setAttribute('data-id', link.id);
                linkItem.draggable = true;
                
                linkItem.innerHTML = `
                    <div class="contact-link-info">
                        <h4>${link.name} 
                            <span class="contact-link-badge ${link.accessType === 'password' ? 'password' : ''}">
                                ${link.accessType === 'free' ? 'Free' : 'Password Protected'}
                            </span>
                        </h4>
                        <p>Type: ${link.type}</p>
                        <p>URL: ${link.url}</p>
                        <div class="video-order-controls">
                            <button class="order-btn move-up-btn" data-id="${link.id}" ${index === 0 ? 'disabled' : ''}><i class="fas fa-arrow-up"></i> Move Up</button>
                            <button class="order-btn move-down-btn" data-id="${link.id}" ${index === sortedLinks.length - 1 ? 'disabled' : ''}><i class="fas fa-arrow-down"></i> Move Down</button>
                        </div>
                    </div>
                    <div class="contact-link-actions">
                        <button class="edit-btn" data-id="${link.id}"><i class="fas fa-edit"></i> Edit</button>
                        <button class="delete-btn" data-id="${link.id}"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                `;
                
                contactLinksAdminList.appendChild(linkItem);
            });
            
            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.contact-link-actions .edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const linkId = e.target.getAttribute('data-id');
                    editContactLink(linkId);
                });
            });
            
            document.querySelectorAll('.contact-link-actions .delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const linkId = e.target.getAttribute('data-id');
                    deleteContactLink(linkId);
                });
            });
            
            // Add event listeners for move up/down buttons
            document.querySelectorAll('.contact-link-item .move-up-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const linkId = e.target.getAttribute('data-id');
                    moveContactLinkUp(linkId);
                });
            });
            
            document.querySelectorAll('.contact-link-item .move-down-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const linkId = e.target.getAttribute('data-id');
                    moveContactLinkDown(linkId);
                });
            });
            
            // Initialize drag and drop for contact links
            initContactLinksReordering();
        }

        // NEW: Initialize drag and drop for contact links reordering
        function initContactLinksReordering() {
            const contactLinksAdminList = document.getElementById('contactLinksAdminList');
            
            if (!contactLinksAdminList) return;
            
            let draggedItem = null;
            
            // Add event listeners for drag and drop
            contactLinksAdminList.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('contact-link-item')) {
                    draggedItem = e.target;
                    e.target.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', e.target.outerHTML);
                }
            });
            
            contactLinksAdminList.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(contactLinksAdminList, e.clientY);
                const draggable = document.querySelector('.dragging');
                
                if (draggable) {
                    if (afterElement == null) {
                        contactLinksAdminList.appendChild(draggable);
                    } else {
                        contactLinksAdminList.insertBefore(draggable, afterElement);
                    }
                }
            });
            
            contactLinksAdminList.addEventListener('dragend', (e) => {
                if (e.target.classList.contains('contact-link-item')) {
                    e.target.classList.remove('dragging');
                    draggedItem = null;
                    
                    // Remove drag-over class from all items
                    document.querySelectorAll('.contact-link-item').forEach(item => {
                        item.classList.remove('drag-over');
                    });
                }
            });
            
            // Helper function to determine where to place the dragged item
            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.contact-link-item:not(.dragging)')];
                
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }
        }

        // NEW: Move contact link up in the order
        function moveContactLinkUp(linkId) {
            const currentIndex = contactLinksOrder.indexOf(linkId);
            if (currentIndex > 0) {
                // Swap with the previous item
                const temp = contactLinksOrder[currentIndex - 1];
                contactLinksOrder[currentIndex - 1] = linkId;
                contactLinksOrder[currentIndex] = temp;
                
                // Re-render the admin contact links list
                renderAdminContactLinksList();
            }
        }

        // NEW: Move contact link down in the order
        function moveContactLinkDown(linkId) {
            const currentIndex = contactLinksOrder.indexOf(linkId);
            if (currentIndex < contactLinksOrder.length - 1) {
                // Swap with the next item
                const temp = contactLinksOrder[currentIndex + 1];
                contactLinksOrder[currentIndex + 1] = linkId;
                contactLinksOrder[currentIndex] = temp;
                
                // Re-render the admin contact links list
                renderAdminContactLinksList();
            }
        }

        // NEW: Save contact links order when admin reorders links
        function saveContactLinksOrder() {
            // Get the current order from the DOM
            const linkItems = Array.from(contactLinksAdminList.querySelectorAll('.contact-link-item'));
            const newOrder = linkItems.map(item => item.getAttribute('data-id'));
            
            contactLinksOrder = newOrder;
            
            // Save to Firebase if online
            if (navigator.onLine && !isOfflineMode) {
                saveContactLinksOrderToFirebase();
                alert('Contact links order saved successfully!');
            } else {
                // Save to offline storage only
                saveContactLinksOrderOffline(contactLinksOrder);
                alert('Contact links order saved for offline use. Will sync when online.');
            }
            
            // Update the contact links screen
            renderContactLinksScreen();
        }

        // NEW: Add contact link
        function addContactLink() {
            const url = contactLinkUrl.value;
            const name = contactLinkName.value;
            const type = contactLinkType.value;
            const accessType = contactLinkAccess.value;
            
            if (!url || !name) {
                alert('Please enter both URL and display name');
                return;
            }
            
            if (navigator.onLine && !isOfflineMode) {
                db.collection('contactLinks').add({
                    url: url,
                    name: name,
                    type: type,
                    accessType: accessType,
                    added: firebase.firestore.FieldValue.serverTimestamp()
                }).then((docRef) => {
                    alert('Contact link added successfully!');
                    
                    // Clear input fields
                    contactLinkUrl.value = '';
                    contactLinkName.value = '';
                    
                    // Reload contact links
                    loadContactLinks();
                }).catch(error => {
                    console.error('Error adding contact link:', error);
                    alert('Error adding contact link. Please try again.');
                });
            } else {
                alert('Cannot add contact links while offline. Please connect to the internet.');
            }
        }

        // NEW: Edit contact link
        function editContactLink(linkId) {
            const link = contactLinksData.find(l => l.id === linkId);
            if (link) {
                const newUrl = prompt('Enter new URL:', link.url);
                const newName = prompt('Enter new display name:', link.name);
                const newType = prompt('Enter new type (facebook, telegram, viber, other):', link.type);
                const newAccessType = prompt('Enter access type (free or password):', link.accessType);
                
                if (newUrl && newName && newType && newAccessType) {
                    if (navigator.onLine && !isOfflineMode) {
                        db.collection('contactLinks').doc(linkId).update({
                            url: newUrl,
                            name: newName,
                            type: newType,
                            accessType: newAccessType
                        }).then(() => {
                            loadContactLinks();
                            alert('Contact link updated successfully!');
                        }).catch(error => {
                            console.error('Error updating contact link:', error);
                            alert('Error updating contact link. Please try again.');
                        });
                    } else {
                        // Update local data only
                        link.url = newUrl;
                        link.name = newName;
                        link.type = newType;
                        link.accessType = newAccessType;
                        saveContactLinksOffline(contactLinksData);
                        loadContactLinks();
                        alert('Contact link updated locally. Will sync when online.');
                    }
                }
            }
        }

        // NEW: Delete contact link
        function deleteContactLink(linkId) {
            if (confirm('Are you sure you want to delete this contact link?')) {
                if (navigator.onLine && !isOfflineMode) {
                    db.collection('contactLinks').doc(linkId).delete().then(() => {
                        loadContactLinks();
                        alert('Contact link deleted successfully!');
                    }).catch(error => {
                        console.error('Error deleting contact link:', error);
                        alert('Error deleting contact link. Please try again.');
                    });
                } else {
                    // Update local data only
                    contactLinksData = contactLinksData.filter(l => l.id !== linkId);
                    saveContactLinksOffline(contactLinksData);
                    loadContactLinks();
                    alert('Contact link deleted locally. Will sync when online.');
                }
            }
        }

        // NEW: Load first play video settings
        function loadFirstPlayVideoSettings() {
            // Try to load from Firebase first
            if (navigator.onLine && !isOfflineMode) {
                db.collection('settings').doc('firstPlayVideo').get().then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        firstPlayVideoId = data.videoId;
                        autoPlayVideoOnStart = data.autoPlay || false;
                        
                        // Save to offline storage
                        saveFirstPlayVideoOffline(data);
                        
                        console.log('First play video settings loaded:', firstPlayVideoId, autoPlayVideoOnStart);
                        
                        // Auto-play the first play video on app start if enabled
                        if (autoPlayVideoOnStart && firstPlayVideoId) {
                            setTimeout(() => {
                                autoPlayFirstVideo();
                            }, 1000);
                        }
                    } else {
                        // No first play video settings exist yet
                        loadFirstPlayVideoOffline();
                    }
                }).catch(error => {
                    console.error('Error loading first play video settings from Firebase:', error);
                    // Fall back to offline storage
                    loadFirstPlayVideoOffline();
                });
            } else {
                // Offline mode - load from local storage
                loadFirstPlayVideoOffline();
            }
        }

        // NEW: Save first play video settings to offline storage
        function saveFirstPlayVideoOffline(data) {
            if (!dbInstance) return;
            
            const transaction = dbInstance.transaction(['appData'], 'readwrite');
            const store = transaction.objectStore('appData');
            store.put({
                key: 'firstPlayVideo',
                data: data
            });
        }

        // NEW: Load first play video settings from offline storage
        function loadFirstPlayVideoOffline() {
            if (!dbInstance) return;
            
            const transaction = dbInstance.transaction(['appData'], 'readonly');
            const store = transaction.objectStore('appData');
            const request = store.get('firstPlayVideo');
            
            request.onsuccess = () => {
                if (request.result) {
                    const data = request.result.data;
                    firstPlayVideoId = data.videoId;
                    autoPlayVideoOnStart = data.autoPlay || false;
                    
                    console.log('First play video settings loaded from offline storage:', firstPlayVideoId, autoPlayVideoOnStart);
                    
                    // Auto-play the first play video on app start if enabled
                    if (autoPlayVideoOnStart && firstPlayVideoId) {
                        setTimeout(() => {
                            autoPlayFirstVideo();
                        }, 1000);
                    }
                }
            };
        }

        // NEW: Save first play video settings to Firebase
        function saveFirstPlayVideoSettings(videoId, autoPlay) {
            const data = {
                videoId: videoId,
                autoPlay: autoPlay,
                updated: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            firstPlayVideoId = videoId;
            autoPlayVideoOnStart = autoPlay;
            
            // Save to Firebase if online
            if (navigator.onLine && !isOfflineMode) {
                db.collection('settings').doc('firstPlayVideo').set(data)
                .then(() => {
                    console.log('First play video settings saved to Firebase');
                    alert('First play video settings saved successfully!');
                })
                .catch(error => {
                    console.error('Error saving first play video settings to Firebase:', error);
                    alert('Error saving first play video settings. Please try again.');
                });
            } else {
                // Save to offline storage only
                saveFirstPlayVideoOffline(data);
                alert('First play video settings saved for offline use. Will sync when online.');
            }
        }

        // NEW: Auto-play the first play video
        function autoPlayFirstVideo() {
            if (!firstPlayVideoId) return;
            
            const video = videos.find(v => v.id === firstPlayVideoId);
            if (video) {
                // Check if video is free or user is logged in
                if (video.passwordType === 'free' || isUserLoggedIn) {
                    console.log('Auto-playing first play video:', video.name);
                    playVideo(video);
                    
                    // Set the video to loop
                    if (currentVideoElement && currentVideoElement.tagName === 'VIDEO') {
                        currentVideoElement.loop = true;
                    }
                }
            }
        }

        // NEW: Set first play video
        function setFirstPlayVideo(videoId) {
            if (confirm('Set this video as the first play video? It will automatically play when the app starts.')) {
                saveFirstPlayVideoSettings(videoId, true);
                
                // Update the admin video list to reflect the change
                renderAdminVideoList();
            }
        }

        // NEW: Remove first play video
        function removeFirstPlayVideo() {
            if (confirm('Remove this video as the first play video?')) {
                saveFirstPlayVideoSettings(null, false);
                
                // Update the admin video list to reflect the change
                renderAdminVideoList();
            }
        }

        // Initialize app
        async function initApp() {
            currentDeviceId = generateDeviceId();
            
            // Create digital particles
            createParticles();
            
            // Initialize PWA Install functionality
            initPWAInstall();
            
            // Initialize IndexedDB
            try {
                await initIndexedDB();
                console.log('IndexedDB initialized successfully');
            } catch (error) {
                console.error('Error initializing IndexedDB:', error);
            }
            
            // Monitor connection status
            monitorConnection();
            
            // Auto-adjust video quality based on network
            autoAdjustVideoQuality();
            
            // Check if user is already logged in
            auth.onAuthStateChanged(user => {
                if (user && user.email === 'admin@kachinvisions.com') {
                    currentUser = user;
                    isAdmin = true;
                    secondAdminSection.style.display = 'block';
                    
                    // Initialize rich text editor for admin
                    initRichTextEditor();
                    
                    // Load admin message into editor
                    loadAdminMessageToEditor();
                    
                    // Initialize video reordering
                    initVideoReordering();
                } else {
                    currentUser = null;
                    isAdmin = false;
                    secondAdminSection.style.display = 'none';
                }
            });

            // Load admin message
            loadAdminMessage();

            // Load black bar settings
            loadBlackBarSettings();

            // Load first play video settings
            loadFirstPlayVideoSettings();

            // Load videos, passwords, and contact links from Firebase
            await loadVideos();
            await loadPasswords();
            await loadContactLinks();
            
            // Load video order
            loadVideoOrder();
            
            // Preload videos for faster playback
            preloadVideos();
            
            // Set up real-time listeners
            setupRealtimeListeners();
            
            // Apply video protection measures
            applyVideoProtection();
            
            // Clear any existing login status on app start
            clearLoginStatus();
            
            // Update storage display
            updateStorageDisplay();
        }

        // Clear login status on app start
        function clearLoginStatus() {
            // Clear any stored login data
            localStorage.removeItem('userPassword');
            localStorage.removeItem('unlockedVideos');
            localStorage.removeItem('currentDeviceId');
            
            // Reset login status
            isUserLoggedIn = false;
            loginStatus.textContent = 'Please enter your password to unlock videos';
            loginStatus.style.color = 'var(--accent)';
            
            // Clear password field
            document.getElementById('password').value = '';
            
            // Re-render video list to show locked state
            renderVideoList();
            
            // Re-render contact links screen
            renderContactLinksScreen();
        }

        // Apply video download protection
        function applyVideoProtection() {
            // Prevent right-click context menu on the video player
            mainVideoPlayer.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
            
            // Prevent keyboard shortcuts for saving
            document.addEventListener('keydown', function(e) {
                // Disable F12, Ctrl+S, Ctrl+Shift+S, Ctrl+U
                if (e.keyCode === 123 || 
                    (e.ctrlKey && e.keyCode === 83) || 
                    (e.ctrlKey && e.shiftKey && e.keyCode === 83) ||
                    (e.ctrlKey && e.keyCode === 85)) {
                    e.preventDefault();
                    return false;
                }
            });
            
            // Remove download option from context menu (if browser supports it)
            if (mainVideoElement) {
                mainVideoElement.controlsList = 'nodownload';
            }
        }

        // Load videos from Firebase
        async function loadVideos() {
            try {
                // Try to load from Firebase first
                if (navigator.onLine && !isOfflineMode) {
                    const snapshot = await db.collection('videos').get();
                    videos = [];
                    snapshot.forEach(doc => {
                        videos.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Save to offline storage
                    saveVideosOffline(videos);
                    
                    await renderVideoList();
                    renderAdminVideoList();
                } else {
                    // Offline mode - load from local storage
                    await loadVideosFromOffline();
                }
            } catch (error) {
                console.error('Error loading videos:', error);
                // Try to load from offline storage
                await loadVideosFromOffline();
            }
        }

        // Save videos to offline storage
        function saveVideosOffline(videosData) {
            if (!dbInstance) return;
            
            const transaction = dbInstance.transaction(['appData'], 'readwrite');
            const store = transaction.objectStore('appData');
            store.put({
                key: 'videos',
                data: videosData
            });
        }

        // Load videos from offline storage
        async function loadVideosFromOffline() {
            if (!dbInstance) {
                await renderVideoList();
                return;
            }
            
            const transaction = dbInstance.transaction(['appData'], 'readonly');
            const store = transaction.objectStore('appData');
            const request = store.get('videos');
            
            request.onsuccess = () => {
                if (request.result) {
                    videos = request.result.data;
                    renderVideoList();
                    renderAdminVideoList();
                } else {
                    // No videos in offline storage
                    renderVideoList();
                }
            };
            
            request.onerror = () => {
                renderVideoList();
            };
        }

        // Load passwords from Firebase
        function loadPasswords() {
            // Try to load from Firebase first
            if (navigator.onLine && !isOfflineMode) {
                db.collection('passwords').get().then(snapshot => {
                    passwords = [];
                    snapshot.forEach(doc => {
                        passwords.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Save to offline storage
                    savePasswordsOffline(passwords);
                    
                    renderPasswordList();
                }).catch(error => {
                    console.error('Error loading passwords:', error);
                    // Fall back to offline storage
                    loadPasswordsOffline();
                });
            } else {
                // Offline mode - load from local storage
                loadPasswordsOffline();
            }
        }

        // Save passwords to offline storage
        function savePasswordsOffline(passwordsData) {
            if (!dbInstance) return;
            
            const transaction = dbInstance.transaction(['appData'], 'readwrite');
            const store = transaction.objectStore('appData');
            store.put({
                key: 'passwords',
                data: passwordsData
            });
        }

        // Load passwords from offline storage
        function loadPasswordsOffline() {
            if (!dbInstance) {
                renderPasswordList();
                return;
            }
            
            const transaction = dbInstance.transaction(['appData'], 'readonly');
            const store = transaction.objectStore('appData');
            const request = store.get('passwords');
            
            request.onsuccess = () => {
                if (request.result) {
                    passwords = request.result.data;
                    renderPasswordList();
                } else {
                    // No passwords in offline storage
                    renderPasswordList();
                }
            };
            
            request.onerror = () => {
                renderPasswordList();
            };
        }

        // Set up real-time listeners for online status
        function setupRealtimeListeners() {
            // User online status
            const userStatusRef = rtdb.ref('userStatus');
            
            userStatusRef.on('value', snapshot => {
                const statusData = snapshot.val();
                if (statusData) {
                    // Update password list with online status
                    renderPasswordList();
                }
            });
            
            // Set up real-time listener for admin message
            if (navigator.onLine && !isOfflineMode) {
                db.collection('settings').doc('adminMessage')
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const data = doc.data();
                            adminMessageData = data;
                            renderAdminMessage();
                            
                            // Save to offline storage
                            saveAdminMessageOffline(data);
                            
                            // If admin is logged in, update the editor too
                            if (isAdmin) {
                                loadAdminMessageToEditor();
                            }
                        }
                    });
            }
            
            // Set current user as online if logged in
            if (currentUser && navigator.onLine && !isOfflineMode) {
                const userStatusRef = rtdb.ref('userStatus/' + currentUser.uid);
                userStatusRef.set({
                    online: true,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Set user as offline when they disconnect
                userStatusRef.onDisconnect().set({
                    online: false,
                    lastSeen: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        // Render video list with offline indicators and password protection
        async function renderVideoList() {
            videoList.innerHTML = '';
            
            // Sort videos according to saved order
            const sortedVideos = sortVideosByOrder();
            
            for (const video of sortedVideos) {
                const videoItem = document.createElement('div');
                
                // Check if video is free or requires password
                if (video.passwordType === 'free') {
                    videoItem.className = 'video-item free';
                } else {
                    videoItem.className = isUserLoggedIn ? 'video-item' : 'video-item locked';
                }
                
                // Check if video is cached
                const isCached = video.cached || (await getCachedVideo(video.id)) !== null;
                
                videoItem.innerHTML = `
                    <div>
                        <h4>${video.name}</h4>
                        <p>${video.type}</p>
                    </div>
                    ${video.passwordType === 'free' ? '<span class="free-badge">Free</span>' : ''}
                    ${isCached ? '<span class="offline-badge">Offline</span>' : ''}
                `;
                
                videoItem.addEventListener('click', async () => {
                    if (!videoItem.classList.contains('locked')) {
                        await playVideo(video);
                    } else if (video.passwordType === 'free') {
                        await playVideo(video);
                    } else {
                        alert('This video requires a password. Please enter your password to unlock all videos.');
                    }
                });
                
                videoList.appendChild(videoItem);
            }
        }

        // Render admin video list with edit/delete options and reordering
        function renderAdminVideoList() {
            videoAdminList.innerHTML = '';
            
            // Sort videos according to saved order
            const sortedVideos = sortVideosByOrder();
            
            sortedVideos.forEach((video, index) => {
                const videoItem = document.createElement('div');
                videoItem.className = 'video-admin-item';
                videoItem.setAttribute('data-id', video.id);
                videoItem.draggable = true;
                
                // Check if this is the first play video
                const isFirstPlayVideo = video.id === firstPlayVideoId;
                
                videoItem.innerHTML = `
                    <div class="video-admin-info">
                        <h4>${video.name} ${isFirstPlayVideo ? '<span style="color: var(--success);">(First Play)</span>' : ''}</h4>
                        <p>Type: ${video.type}</p>
                        <p>Access: ${video.passwordType === 'free' ? 'Free' : 'Password Protected'}</p>
                        <p>URL: ${video.url}</p>
                        <div class="video-order-controls">
                            <button class="order-btn move-up-btn" data-id="${video.id}" ${index === 0 ? 'disabled' : ''}><i class="fas fa-arrow-up"></i> Move Up</button>
                            <button class="order-btn move-down-btn" data-id="${video.id}" ${index === sortedVideos.length - 1 ? 'disabled' : ''}><i class="fas fa-arrow-down"></i> Move Down</button>
                        </div>
                    </div>
                    <div class="video-admin-actions">
                        <button class="cache-btn" data-id="${video.id}"><i class="fas fa-download"></i> Cache Offline</button>
                        <button class="first-play-btn ${isFirstPlayVideo ? 'active' : ''}" data-id="${video.id}">
                            <i class="fas fa-play-circle"></i> ${isFirstPlayVideo ? 'First Play ON' : 'Set First Play'}
                        </button>
                        <button class="edit-btn" data-id="${video.id}"><i class="fas fa-edit"></i> Edit</button>
                        <button class="delete-btn" data-id="${video.id}"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                `;
                
                videoAdminList.appendChild(videoItem);
            });
            
            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.video-admin-actions .edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const videoId = e.target.getAttribute('data-id');
                    editVideo(videoId);
                });
            });
            
            document.querySelectorAll('.video-admin-actions .delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const videoId = e.target.getAttribute('data-id');
                    deleteVideo(videoId);
                });
            });
            
            document.querySelectorAll('.video-admin-actions .cache-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const videoId = e.target.getAttribute('data-id');
                    const video = videos.find(v => v.id === videoId);
                    if (video) {
                        e.target.innerHTML = '<i class="fas fa-spinner loading"></i> Caching...';
                        e.target.disabled = true;
                        
                        try {
                            await cacheVideo(video);
                            alert('Video cached for offline viewing!');
                            updateStorageDisplay();
                            renderVideoList();
                        } catch (error) {
                            alert('Error caching video. Please try again.');
                        }
                        
                        e.target.innerHTML = '<i class="fas fa-download"></i> Cache Offline';
                        e.target.disabled = false;
                    }
                });
            });
            
            // Add event listeners for move up/down buttons
            document.querySelectorAll('.move-up-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const videoId = e.target.getAttribute('data-id');
                    moveVideoUp(videoId);
                });
            });
            
            document.querySelectorAll('.move-down-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const videoId = e.target.getAttribute('data-id');
                    moveVideoDown(videoId);
                });
            });
            
            // Add event listeners for first play buttons
            document.querySelectorAll('.first-play-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const videoId = e.target.getAttribute('data-id');
                    const isActive = e.target.classList.contains('active');
                    
                    if (isActive) {
                        removeFirstPlayVideo();
                    } else {
                        setFirstPlayVideo(videoId);
                    }
                });
            });
        }

        // Move video up in the order
        function moveVideoUp(videoId) {
            const currentIndex = videoOrder.indexOf(videoId);
            if (currentIndex > 0) {
                // Swap with the previous item
                const temp = videoOrder[currentIndex - 1];
                videoOrder[currentIndex - 1] = videoId;
                videoOrder[currentIndex] = temp;
                
                // Re-render the admin video list
                renderAdminVideoList();
            }
        }

        // Move video down in the order
        function moveVideoDown(videoId) {
            const currentIndex = videoOrder.indexOf(videoId);
            if (currentIndex < videoOrder.length - 1) {
                // Swap with the next item
                const temp = videoOrder[currentIndex + 1];
                videoOrder[currentIndex + 1] = videoId;
                videoOrder[currentIndex] = temp;
                
                // Re-render the admin video list
                renderAdminVideoList();
            }
        }

        // Render password list with device information
        function renderPasswordList() {
            userList.innerHTML = '';
            
            const searchTerm = passwordSearch.value.toLowerCase();
            let filteredPasswords = passwords;
            
            if (searchTerm) {
                filteredPasswords = passwords.filter(p => 
                    p.password.toLowerCase().includes(searchTerm)
                );
            }
            
            filteredPasswords.forEach(password => {
                const passwordItem = document.createElement('div');
                passwordItem.className = 'user-item';
                
                // Get device info if available
                const deviceInfo = password.deviceId ? {
                    deviceId: password.deviceId,
                    loginTime: password.loginTime || new Date().toISOString(),
                    isCurrent: password.deviceId === currentDeviceId
                } : null;
                
                passwordItem.innerHTML = `
                    <div class="user-info">
                        <h4>Password: ${password.password} 
                            <span class="online-status ${deviceInfo ? 'online' : 'offline'}"></span>
                        </h4>
                        
                        <div class="device-info">
                            <strong>Registered Device:</strong>
                            <div class="device-list">
                                ${deviceInfo ? 
                                    `<div class="device-item">
                                        <div>
                                            <small>Device ID: ${deviceInfo.deviceId.substring(0, 15)}...</small><br>
                                            <small>Registered: ${new Date(deviceInfo.loginTime).toLocaleString()}</small>
                                            ${deviceInfo.isCurrent ? ' <strong>(Current Device)</strong>' : ''}
                                        </div>
                                    </div>` : 
                                    '<small>No device registered</small>'
                                }
                            </div>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="edit-btn" data-id="${password.id}"><i class="fas fa-edit"></i> Edit</button>
                        <button class="reset-device-btn" data-id="${password.id}"><i class="fas fa-sync"></i> Reset Device</button>
                        <button class="delete-btn" data-id="${password.id}"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                `;
                
                userList.appendChild(passwordItem);
            });
            
            // Add event listeners for edit, delete, and reset device buttons
            document.querySelectorAll('.user-actions .edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const passwordId = e.target.getAttribute('data-id');
                    editPassword(passwordId);
                });
            });
            
            document.querySelectorAll('.user-actions .delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const passwordId = e.target.getAttribute('data-id');
                    deletePassword(passwordId);
                });
            });
            
            document.querySelectorAll('.user-actions .reset-device-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const passwordId = e.target.getAttribute('data-id');
                    resetPasswordDevice(passwordId);
                });
            });
        }

        // Play video with offline support and error handling
        async function playVideo(video) {
            // Destroy any existing HLS instance
            if (hls) {
                hls.destroy();
                hls = null;
            }
            
            let videoUrl = video.url;
            
            // Check if we're offline or prefer to use cached video
            if (!navigator.onLine || isOfflineMode || video.cached) {
                const cachedVideo = await getCachedVideo(video.id);
                if (cachedVideo) {
                    videoUrl = cachedVideo;
                    console.log('Playing cached video in proprietary format:', video.name);
                } else if (!navigator.onLine || isOfflineMode) {
                    showError('Video not available offline. Please connect to the internet to watch this video.');
                    return;
                }
            }
            
            // Clear the main video player
            mainVideoPlayer.innerHTML = '';
            
            // Create video player wrapper
            const videoPlayerWrapper = document.createElement('div');
            videoPlayerWrapper.className = 'video-player-wrapper';
            
            // Create black bars
            const topBar = document.createElement('div');
            topBar.id = 'topBlackBar';
            topBar.className = 'black-bars top-bar';
            topBar.style.height = blackBarSettings.top + 'px';
            
            const bottomBar = document.createElement('div');
            bottomBar.id = 'bottomBlackBar';
            bottomBar.className = 'black-bars bottom-bar';
            bottomBar.style.height = blackBarSettings.bottom + 'px';
            
            // Create video content area
            const videoContent = document.createElement('div');
            videoContent.className = 'video-content';
            const totalBarHeight = blackBarSettings.top + blackBarSettings.bottom;
            videoContent.style.height = `calc(100% - ${totalBarHeight}px)`;
            
            // Check if it's a YouTube video
            if (video.type === 'youtube') {
                // Create iframe for YouTube video with proper configuration
                const iframe = document.createElement('iframe');
                iframe.className = 'youtube-iframe';
                
                // Extract video ID and create proper embed URL
                const videoId = extractYouTubeId(video.url);
                if (!videoId) {
                    showError('Invalid YouTube URL format');
                    return;
                }
                
                // Create proper YouTube embed URL with minimal parameters
                const embedUrl = `https://www.youtube.com/embed/${videoId}`;
                
                iframe.src = embedUrl;
                iframe.allowFullscreen = true;
                iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
                iframe.referrerPolicy = 'strict-origin-when-cross-origin';
                iframe.frameBorder = '0';
                iframe.title = video.name;
                
                videoContent.appendChild(iframe);
                currentVideoElement = iframe;
                
                // Show fullscreen button for YouTube
                fullscreenBtn.style.display = 'block';
                fullscreenBtn.textContent = 'Full Screen';
                
                // Add error handling for YouTube iframe
                iframe.onload = () => {
                    console.log('YouTube iframe loaded successfully');
                };
                
                iframe.onerror = () => {
                    showError('Failed to load YouTube video. Please check the URL and try again.');
                };
            } 
            // Check if it's an Instagram video
            else if (video.type === 'instagram') {
                // Create container for Instagram video
                const instagramContainer = document.createElement('div');
                instagramContainer.className = 'instagram-container';
                
                // Create iframe for Instagram video
                const iframe = document.createElement('iframe');
                iframe.className = 'instagram-iframe';
                
                // Extract Instagram post ID and create embed URL
                const postId = extractInstagramPostId(video.url);
                if (!postId) {
                    showError('Invalid Instagram URL format');
                    return;
                }
                
                // Create Instagram embed URL
                const embedUrl = `https://www.instagram.com/p/${postId}/embed/`;
                
                iframe.src = embedUrl;
                iframe.allowFullscreen = true;
                iframe.allow = 'encrypted-media';
                iframe.referrerPolicy = 'strict-origin-when-cross-origin';
                iframe.frameBorder = '0';
                iframe.scrolling = 'no';
                iframe.title = video.name;
                
                instagramContainer.appendChild(iframe);
                videoContent.appendChild(instagramContainer);
                currentVideoElement = iframe;
                
                // Show fullscreen button for Instagram
                fullscreenBtn.style.display = 'block';
                fullscreenBtn.textContent = 'Full Screen';
                
                // Add error handling for Instagram iframe
                iframe.onload = () => {
                    console.log('Instagram iframe loaded successfully');
                    
                    // Auto-fit Instagram video after loading
                    setTimeout(() => {
                        autoFitInstagramVideo(iframe);
                    }, 1000);
                };
                
                iframe.onerror = () => {
                    showError('Failed to load Instagram video. Please check the URL and try again.');
                };
            }
            // Check if it's a TikTok video
            else if (video.type === 'tiktok') {
                // Create container for TikTok video
                const tiktokContainer = document.createElement('div');
                tiktokContainer.className = 'tiktok-container';
                
                // Create iframe for TikTok video
                const iframe = document.createElement('iframe');
                iframe.className = 'tiktok-iframe';
                
                // Extract TikTok video ID and create embed URL
                const videoId = extractTikTokId(video.url);
                if (!videoId) {
                    showError('Invalid TikTok URL format');
                    return;
                }
                
                // Create TikTok embed URL with proper parameters
                const embedUrl = `https://www.tiktok.com/embed/v2/${videoId}?lang=en-US`;
                
                iframe.src = embedUrl;
                iframe.allowFullscreen = true;
                iframe.allow = 'encrypted-media';
                iframe.referrerPolicy = 'strict-origin-when-cross-origin';
                iframe.frameBorder = '0';
                iframe.scrolling = 'no';
                iframe.title = video.name;
                
                tiktokContainer.appendChild(iframe);
                videoContent.appendChild(tiktokContainer);
                currentVideoElement = iframe;
                
                // Show fullscreen button for TikTok
                fullscreenBtn.style.display = 'block';
                fullscreenBtn.textContent = 'Full Screen';
                
                // Add error handling for TikTok iframe
                iframe.onload = () => {
                    console.log('TikTok iframe loaded successfully');
                    
                    // Auto-fit TikTok video after loading
                    setTimeout(() => {
                        autoFitTikTokVideo(iframe);
                    }, 1000);
                };
                
                iframe.onerror = () => {
                    showError('Failed to load TikTok video. Please check the URL and try again.');
                };
            }
            // Check if it's an HLS stream
            else if (video.type === 'hls' && video.url && video.url.endsWith('.m3u8')) {
                if (Hls.isSupported()) {
                    // Create video element for HLS
                    const videoElement = document.createElement('video');
                    videoElement.id = 'mainVideoElement';
                    videoElement.controls = true;
                    videoElement.autoplay = true;
                    videoElement.muted = false;
                    videoElement.loop = false;
                    videoElement.controlsList = 'nodownload';
                    videoElement.style.width = '100%';
                    videoElement.style.height = '100%';
                    
                    videoContent.appendChild(videoElement);
                    currentVideoElement = videoElement;
                    
                    hls = new Hls({
                        enableWorker: false, // Disable worker for better mobile compatibility
                        lowLatencyMode: true,
                        backBufferLength: 90
                    });
                    
                    hls.loadSource(videoUrl);
                    hls.attachMedia(videoElement);
                    
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        console.log('HLS manifest parsed successfully');
                        applyVideoQualitySettings(videoElement);
                    });
                    
                    // Handle errors
                    hls.on(Hls.Events.ERROR, function(event, data) {
                        console.error('HLS error:', data);
                        if (data.fatal) {
                            switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    console.error('Network error, trying to recover');
                                    hls.startLoad();
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    console.error('Media error, trying to recover');
                                    hls.recoverMediaError();
                                    break;
                                default:
                                    console.error('Fatal error, cannot recover');
                                    showError('HLS stream error. Please try another video.');
                                    break;
                            }
                        }
                    });
                    
                    // Show fullscreen button for HLS
                    fullscreenBtn.style.display = 'block';
                    fullscreenBtn.textContent = 'Full Screen';
                    
                    // Show quality selector for HLS
                    qualitySelector.style.display = 'block';
                } else if (mainVideoElement && mainVideoElement.canPlayType('application/vnd.apple.mpegurl')) {
                    // Safari native HLS support
                    mainVideoElement.src = videoUrl;
                    currentVideoElement = mainVideoElement;
                    
                    // Show fullscreen button for HLS
                    fullscreenBtn.style.display = 'block';
                    fullscreenBtn.textContent = 'Full Screen';
                } else {
                    console.error('HLS is not supported in this browser');
                    showError('HLS video is not supported in your browser. Please try a different browser.');
                    return;
                }
            } else {
                // Regular video (MP4, WebM, etc.)
                // Create video element for regular videos
                const videoElement = document.createElement('video');
                videoElement.id = 'mainVideoElement';
                videoElement.controls = true;
                videoElement.autoplay = true;
                videoElement.muted = false;
                videoElement.loop = false;
                videoElement.controlsList = 'nodownload';
                videoElement.style.width = '100%';
                videoElement.style.height = '100%';
                
                const source = document.createElement('source');
                source.src = videoUrl;
                
                // Set appropriate MIME type based on file extension
                if (videoUrl.toLowerCase().endsWith('.webm')) {
                    source.type = 'video/webm';
                } else if (videoUrl.toLowerCase().endsWith('.ogg') || videoUrl.toLowerCase().endsWith('.ogv')) {
                    source.type = 'video/ogg';
                } else {
                    source.type = 'video/mp4'; // Default to MP4
                }
                
                videoElement.appendChild(source);
                videoElement.innerHTML += 'Your browser does not support the video tag.';
                
                videoContent.appendChild(videoElement);
                currentVideoElement = videoElement;
                
                // Apply quality settings
                applyVideoQualitySettings(videoElement);
                
                // Show fullscreen button for regular videos
                fullscreenBtn.style.display = 'block';
                fullscreenBtn.textContent = 'Full Screen';
                
                // Add error handling for regular videos
                videoElement.onerror = () => {
                    showError('Failed to load video. Please check the URL and try again.');
                };
            }
            
            // Assemble the video player
            videoPlayerWrapper.appendChild(topBar);
            videoPlayerWrapper.appendChild(videoContent);
            videoPlayerWrapper.appendChild(bottomBar);
            mainVideoPlayer.appendChild(videoPlayerWrapper);
            
            // Re-apply protection after changing video source
            applyVideoProtection();
            
            // Auto-cache video for offline viewing if online and not YouTube/Instagram/TikTok
            if (navigator.onLine && !isOfflineMode && !video.cached && video.type !== 'youtube' && video.type !== 'instagram' && video.type !== 'tiktok') {
                setTimeout(() => {
                    cacheVideo(video).then(() => {
                        console.log('Video auto-cached in proprietary format:', video.name);
                        updateStorageDisplay();
                        renderVideoList();
                    }).catch(error => {
                        console.error('Error auto-caching video:', error);
                    });
                }, 1000);
            }
            
            // Highlight the playing video in the list
            document.querySelectorAll('.video-item').forEach(item => {
                item.classList.remove('playing');
            });
            
            const videoItems = document.querySelectorAll('.video-item');
            for (let i = 0; i < videoItems.length; i++) {
                const itemText = videoItems[i].querySelector('h4').textContent;
                if (itemText === video.name) {
                    videoItems[i].classList.add('playing');
                    break;
                }
            }
        }

        // Auto-fit Instagram video to container
        function autoFitInstagramVideo(iframe) {
            try {
                // Instagram iframes have a fixed height, so we need to adjust the container
                const container = iframe.parentElement;
                const playerWrapper = document.querySelector('.video-player-wrapper');
                
                if (container && playerWrapper) {
                    // Calculate the available height after accounting for black bars
                    const availableHeight = playerWrapper.clientHeight - blackBarSettings.top - blackBarSettings.bottom;
                    
                    // Instagram embed typically has a fixed aspect ratio
                    // We'll set the iframe to fill the available space
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    
                    // Ensure the container fills the available space
                    container.style.width = '100%';
                    container.style.height = '100%';
                    
                    console.log('Instagram video auto-fitted to container');
                }
            } catch (error) {
                console.error('Error auto-fitting Instagram video:', error);
            }
        }

        // Auto-fit TikTok video to container
        function autoFitTikTokVideo(iframe) {
            try {
                // TikTok iframes have a fixed height, so we need to adjust the container
                const container = iframe.parentElement;
                const playerWrapper = document.querySelector('.video-player-wrapper');
                
                if (container && playerWrapper) {
                    // Calculate the available height after accounting for black bars
                    const availableHeight = playerWrapper.clientHeight - blackBarSettings.top - blackBarSettings.bottom;
                    
                    // TikTok embed typically has a fixed aspect ratio
                    // We'll set the iframe to fill the available space
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    
                    // Ensure the container fills the available space
                    container.style.width = '100%';
                    container.style.height = '100%';
                    
                    console.log('TikTok video auto-fitted to container');
                }
            } catch (error) {
                console.error('Error auto-fitting TikTok video:', error);
            }
        }

        // Show error message
        function showError(message) {
            // Remove any existing error message
            const existingError = mainVideoPlayer.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `
                <h4><i class="fas fa-exclamation-triangle"></i> Video Playback Error</h4>
                <p>${message}</p>
                <p><small>If this problem persists, please contact support.</small></p>
            `;
            
            mainVideoPlayer.appendChild(errorDiv);
            fullscreenBtn.style.display = 'none';
            qualitySelector.style.display = 'none';
        }

        // Toggle fullscreen mode
        function toggleFullscreen() {
            if (!currentVideoElement) return;
            
            if (currentVideoElement.requestFullscreen) {
                currentVideoElement.requestFullscreen();
            } else if (currentVideoElement.webkitRequestFullscreen) {
                currentVideoElement.webkitRequestFullscreen();
            } else if (currentVideoElement.mozRequestFullScreen) {
                currentVideoElement.mozRequestFullScreen();
            } else if (currentVideoElement.msRequestFullscreen) {
                currentVideoElement.msRequestFullscreen();
            }
        }

        // Unlock videos for a specific device
        function unlockVideosForDevice() {
            document.querySelectorAll('.video-item').forEach(item => {
                if (!item.classList.contains('free')) {
                    item.classList.remove('locked');
                }
            });
            
            // Update login status
            loginStatus.textContent = `Videos unlocked successfully!`;
            loginStatus.style.color = 'var(--success)';
            isUserLoggedIn = true;
            
            // Also update contact links screen to show password-protected ones
            renderContactLinksScreen();
            
            // Preload videos now that they're unlocked
            preloadVideos();
        }

        // Unlock videos with one device per password restriction
        function unlockVideos() {
            const password = document.getElementById('password').value;
            
            // Check if password matches any password in the database
            const validPassword = passwords.find(p => p.password === password);
            
            if (validPassword) {
                // Check if password already has a device registered
                if (validPassword.deviceId && validPassword.deviceId !== currentDeviceId) {
                    loginStatus.textContent = 'This password is already registered to another device.';
                    loginStatus.style.color = 'var(--danger)';
                    return;
                }
                
                // Update password's device information in Firestore if online
                if (navigator.onLine && !isOfflineMode) {
                    const passwordRef = db.collection('passwords').doc(validPassword.id);
                    
                    passwordRef.update({
                        deviceId: currentDeviceId,
                        loginTime: new Date().toISOString()
                    }).then(() => {
                        // Update local passwords array
                        validPassword.deviceId = currentDeviceId;
                        validPassword.loginTime = new Date().toISOString();
                        
                        // Save updated passwords to offline storage
                        savePasswordsOffline(passwords);
                        
                        completeUnlockProcess(password);
                    }).catch(error => {
                        console.error('Error updating password device info:', error);
                        alert('Error unlocking videos. Please try again.');
                    });
                } else {
                    // Offline mode - update local data only
                    validPassword.deviceId = currentDeviceId;
                    validPassword.loginTime = new Date().toISOString();
                    
                    // Save updated passwords to offline storage
                    savePasswordsOffline(passwords);
                    
                    completeUnlockProcess(password);
                }
            } else {
                loginStatus.textContent = 'Invalid password. Please try again.';
                loginStatus.style.color = 'var(--danger)';
            }
        }

        // Complete the unlock process
        function completeUnlockProcess(password) {
            // Save password for auto-remember (but will be cleared on next app start)
            localStorage.setItem('userPassword', password);
            
            // Unlock videos for this device (but will be cleared on next app start)
            localStorage.setItem('unlockedVideos', 'true');
            localStorage.setItem('currentDeviceId', currentDeviceId);
            
            unlockVideosForDevice();
            
            // Set up real-time session tracking if online
            if (navigator.onLine && !isOfflineMode) {
                setupUserSession(validPassword.id);
            }
            
            alert('Videos unlocked successfully! This device is now registered to this password.');
        }

        // Set up real-time session tracking for the user
        function setupUserSession(passwordId) {
            if (!navigator.onLine || isOfflineMode) return;
            
            userSessionRef = rtdb.ref('userSessions/' + passwordId + '/' + currentDeviceId);
            
            // Set session data
            userSessionRef.set({
                loginTime: new Date().toISOString(),
                lastActive: firebase.database.ServerValue.TIMESTAMP,
                deviceInfo: navigator.userAgent
            });
            
            // Update last active timestamp periodically
            setInterval(() => {
                if (userSessionRef && navigator.onLine && !isOfflineMode) {
                    userSessionRef.update({
                        lastActive: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            }, 30000); // Update every 30 seconds
            
            // Set up disconnect handler
            userSessionRef.onDisconnect().remove();
        }

        // Generate multiple passwords
        function generatePasswords() {
            const count = parseInt(passwordCount.value) || 10;
            
            if (count < 1 || count > 50) {
                alert('Please enter a number between 1 and 50');
                return;
            }
            
            const batch = db.batch();
            const newPasswords = [];
            
            // Clear previous generated passwords display
            generatedPasswords.innerHTML = '<h4 style="margin-bottom: 15px; text-align: center;">Recently Generated Passwords</h4>';
            
            for (let i = 0; i < count; i++) {
                // Generate password in format KV.XXXXXX (6 digits)
                const randomDigits = Math.floor(100000 + Math.random() * 900000);
                const password = `KV.${randomDigits}`;
                
                // Add to batch
                const passwordRef = db.collection('passwords').doc();
                batch.set(passwordRef, {
                    password: password,
                    created: firebase.firestore.FieldValue.serverTimestamp(),
                    deviceId: null // No device registered initially
                });
                
                newPasswords.push(password);
                
                // Add to display
                const passwordItem = document.createElement('div');
                passwordItem.className = 'password-item';
                passwordItem.innerHTML = `
                    <span>${password}</span>
                    <button class="copy-btn" data-password="${password}"><i class="fas fa-copy"></i> Copy</button>
                `;
                generatedPasswords.appendChild(passwordItem);
            }
            
            // Execute batch write if online
            if (navigator.onLine && !isOfflineMode) {
                batch.commit().then(() => {
                    alert(`Successfully generated ${count} passwords!`);
                    loadPasswords();
                    
                    // Add copy functionality to the new buttons
                    document.querySelectorAll('.copy-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const password = e.target.getAttribute('data-password');
                            navigator.clipboard.writeText(password).then(() => {
                                alert(`Password ${password} copied to clipboard!`);
                            }).catch(err => {
                                console.error('Failed to copy password: ', err);
                            });
                        });
                    });
                }).catch(error => {
                    console.error('Error generating passwords:', error);
                    alert('Error generating passwords. Please try again.');
                });
            } else {
                alert('Cannot generate passwords while offline. Please connect to the internet.');
            }
        }

        // Edit password
        function editPassword(passwordId) {
            const password = passwords.find(p => p.id === passwordId);
            if (password) {
                const newPassword = prompt('Enter new password:', password.password);
                
                if (newPassword) {
                    if (navigator.onLine && !isOfflineMode) {
                        db.collection('passwords').doc(passwordId).update({
                            password: newPassword
                        }).then(() => {
                            loadPasswords();
                        }).catch(error => {
                            console.error('Error updating password:', error);
                        });
                    } else {
                        // Update local data only
                        password.password = newPassword;
                        savePasswordsOffline(passwords);
                        loadPasswords();
                        alert('Password updated locally. Will sync when online.');
                    }
                }
            }
        }

        // Delete password
        function deletePassword(passwordId) {
            if (confirm('Are you sure you want to delete this password?')) {
                if (navigator.onLine && !isOfflineMode) {
                    db.collection('passwords').doc(passwordId).delete().then(() => {
                        loadPasswords();
                    }).catch(error => {
                        console.error('Error deleting password:', error);
                        });
                } else {
                    // Update local data only
                    passwords = passwords.filter(p => p.id !== passwordId);
                    savePasswordsOffline(passwords);
                    loadPasswords();
                    alert('Password deleted locally. Will sync when online.');
                }
            }
        }

        // Reset password device (allow registration on a new device)
        function resetPasswordDevice(passwordId) {
            if (confirm('Are you sure you want to reset the device for this password? This will allow the password to be registered on a new device.')) {
                if (navigator.onLine && !isOfflineMode) {
                    db.collection('passwords').doc(passwordId).update({
                        deviceId: null
                    }).then(() => {
                        loadPasswords();
                        alert('Device reset successfully! Password can now be registered on a new device.');
                    }).catch(error => {
                        console.error('Error resetting device:', error);
                        alert('Error resetting device. Please try again.');
                    });
                } else {
                    // Update local data only
                    const password = passwords.find(p => p.id === passwordId);
                    if (password) {
                        password.deviceId = null;
                        savePasswordsOffline(passwords);
                        loadPasswords();
                        alert('Device reset locally. Will sync when online.');
                    }
                }
            }
        }

        // Edit video
        function editVideo(videoId) {
            const video = videos.find(v => v.id === videoId);
            if (video) {
                const newName = prompt('Enter new video name:', video.name);
                const newUrl = prompt('Enter new video URL:', video.url);
                const newType = prompt('Enter new video type:', video.type);
                const newPasswordType = prompt('Enter password type (free or password):', video.passwordType || 'password');
                
                if (newName && newUrl && newType && newPasswordType) {
                    if (navigator.onLine && !isOfflineMode) {
                        db.collection('videos').doc(videoId).update({
                            name: newName,
                            url: newUrl,
                            type: newType,
                            passwordType: newPasswordType
                        }).then(() => {
                            loadVideos();
                            alert('Video updated successfully!');
                        }).catch(error => {
                            console.error('Error updating video:', error);
                            alert('Error updating video. Please try again.');
                        });
                    } else {
                        // Update local data only
                        video.name = newName;
                        video.url = newUrl;
                        video.type = newType;
                        video.passwordType = newPasswordType;
                        saveVideosOffline(videos);
                        loadVideos();
                        alert('Video updated locally. Will sync when online.');
                    }
                }
            }
        }

        // Delete video
        function deleteVideo(videoId) {
            if (confirm('Are you sure you want to delete this video?')) {
                if (navigator.onLine && !isOfflineMode) {
                    db.collection('videos').doc(videoId).delete().then(() => {
                        loadVideos();
                        alert('Video deleted successfully!');
                    }).catch(error => {
                        console.error('Error deleting video:', error);
                        alert('Error deleting video. Please try again.');
                    });
                } else {
                    // Update local data only
                    videos = videos.filter(v => v.id !== videoId);
                    saveVideosOffline(videos);
                    loadVideos();
                    alert('Video deleted locally. Will sync when online.');
                }
            }
        }

        // Add Cloudinary video
        function addCloudinaryVideo() {
            const name = document.getElementById('cloudinaryName').value;
            const url = document.getElementById('cloudinaryUrl').value;
            const passwordType = cloudinaryPasswordType.value;
            
            if (!name || !url) {
                alert('Please enter both display name and URL');
                return;
            }
            
            if (navigator.onLine && !isOfflineMode) {
                db.collection('videos').add({
                    name: name,
                    url: url,
                    type: 'cloudinary',
                    passwordType: passwordType,
                    added: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    alert('Cloudinary video added successfully!');
                    document.getElementById('cloudinaryName').value = '';
                    document.getElementById('cloudinaryUrl').value = '';
                    loadVideos();
                }).catch(error => {
                    console.error('Error adding video:', error);
                    alert('Error adding video. Please try again.');
                });
            } else {
                alert('Cannot add videos while offline. Please connect to the internet.');
            }
        }

        // Add YouTube video
        function addYouTubeVideo() {
            const url = document.getElementById('youtubeUrl').value;
            const passwordType = youtubePasswordType.value;
            
            if (!url) {
                alert('Please enter YouTube URL');
                return;
            }
            
            // Extract video ID from YouTube URL
            const videoId = extractYouTubeId(url);
            if (!videoId) {
                alert('Invalid YouTube URL. Please use a valid YouTube URL format.');
                return;
            }
            
            // Create proper YouTube embed URL
            const embedUrl = `https://www.youtube.com/embed/${videoId}`;
            
            // Get video title if possible
            const videoName = `YouTube Video ${videoId}`;
            
            if (navigator.onLine && !isOfflineMode) {
                db.collection('videos').add({
                    name: videoName,
                    url: embedUrl,
                    type: 'youtube',
                    passwordType: passwordType,
                    added: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    alert('YouTube video added successfully!');
                    document.getElementById('youtubeUrl').value = '';
                    loadVideos();
                }).catch(error => {
                    console.error('Error adding video:', error);
                    alert('Error adding video. Please try again.');
                });
            } else {
                alert('Cannot add videos while offline. Please connect to the internet.');
            }
        }

        // Add Telegram video
        function addTelegramVideo() {
            const url = document.getElementById('telegramUrl').value;
            const passwordType = telegramPasswordType.value;
            
            if (!url) {
                alert('Please enter Telegram URL');
                return;
            }
            
            if (navigator.onLine && !isOfflineMode) {
                db.collection('videos').add({
                    name: `Telegram Video`,
                    url: url,
                    type: 'telegram',
                    passwordType: passwordType,
                    added: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    alert('Telegram video added successfully!');
                    document.getElementById('telegramUrl').value = '';
                    loadVideos();
                }).catch(error => {
                    console.error('Error adding video:', error);
                    alert('Error adding video. Please try again.');
                });
            } else {
                alert('Cannot add videos while offline. Please connect to the internet.');
            }
        }

        // Add HLS stream
        function addHlsVideo() {
            const url = document.getElementById('hlsUrl').value;
            const passwordType = hlsPasswordType.value;
            
            if (!url) {
                alert('Please enter HLS URL');
                return;
            }
            
            // Extract name from URL or use generic name
            const name = `HLS Stream ${new Date().toLocaleDateString()}`;
            
            if (navigator.onLine && !isOfflineMode) {
                db.collection('videos').add({
                    name: name,
                    url: url,
                    type: 'hls',
                    passwordType: passwordType,
                    added: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    alert('HLS stream added successfully!');
                    document.getElementById('hlsUrl').value = '';
                    loadVideos();
                }).catch(error => {
                    console.error('Error adding HLS stream:', error);
                    alert('Error adding HLS stream. Please try again.');
                });
            } else {
                alert('Cannot add videos while offline. Please connect to the internet.');
            }
        }

        // Add Instagram video
        function addInstagramVideo() {
            const url = document.getElementById('instagramUrl').value;
            const passwordType = instagramPasswordType.value;
            
            if (!url) {
                alert('Please enter Instagram URL');
                return;
            }
            
            // Extract post ID from Instagram URL
            const postId = extractInstagramPostId(url);
            if (!postId) {
                alert('Invalid Instagram URL. Please use a valid Instagram post URL.');
                return;
            }
            
            // Create proper Instagram embed URL
            const embedUrl = `https://www.instagram.com/p/${postId}/embed/`;
            
            // Get post name
            const videoName = `Instagram Video ${postId}`;
            
            if (navigator.onLine && !isOfflineMode) {
                db.collection('videos').add({
                    name: videoName,
                    url: embedUrl,
                    type: 'instagram',
                    passwordType: passwordType,
                    added: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    alert('Instagram video added successfully!');
                    document.getElementById('instagramUrl').value = '';
                    loadVideos();
                }).catch(error => {
                    console.error('Error adding Instagram video:', error);
                    alert('Error adding Instagram video. Please try again.');
                });
            } else {
                alert('Cannot add videos while offline. Please connect to the internet.');
            }
        }

        // Add TikTok video
        function addTikTokVideo() {
            const url = document.getElementById('tiktokUrl').value;
            const passwordType = tiktokPasswordType.value;
            
            if (!url) {
                alert('Please enter TikTok URL');
                return;
            }
            
            // Extract video ID from TikTok URL
            const videoId = extractTikTokId(url);
            if (!videoId) {
                alert('Invalid TikTok URL. Please use a valid TikTok video URL.');
                return;
            }
            
            // Create proper TikTok embed URL
            const embedUrl = `https://www.tiktok.com/embed/v2/${videoId}?lang=en-US`;
            
            // Get video name
            const videoName = `TikTok Video ${videoId}`;
            
            if (navigator.onLine && !isOfflineMode) {
                db.collection('videos').add({
                    name: videoName,
                    url: embedUrl,
                    type: 'tiktok',
                    passwordType: passwordType,
                    added: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    alert('TikTok video added successfully!');
                    document.getElementById('tiktokUrl').value = '';
                    loadVideos();
                }).catch(error => {
                    console.error('Error adding TikTok video:', error);
                    alert('Error adding TikTok video. Please try again.');
                });
            } else {
                alert('Cannot add videos while offline. Please connect to the internet.');
            }
        }

        // Extract YouTube video ID from URL
        function extractYouTubeId(url) {
            // Handle various YouTube URL formats
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&?#]+)/,
                /youtube\.com\/watch\?.*v=([^&?#]+)/,
                /youtu\.be\/([^&?#]+)/,
                /youtube\.com\/embed\/([^&?#]+)/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            
            return null;
        }

        // Extract Instagram post ID from URL
        function extractInstagramPostId(url) {
            // Handle various Instagram URL formats
            const patterns = [
                /instagram\.com\/p\/([^\/?#]+)/,
                /instagram\.com\/reel\/([^\/?#]+)/,
                /instagram\.com\/tv\/([^\/?#]+)/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            
            return null;
        }

        // Extract TikTok video ID from URL
        function extractTikTokId(url) {
            // Handle various TikTok URL formats
            const patterns = [
                /tiktok\.com\/@[^\/]+\/video\/([^\/?#]+)/,
                /vm\.tiktok\.com\/([^\/?#]+)/,
                /vt\.tiktok\.com\/([^\/?#]+)/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            
            return null;
        }

        // Apply top black bar
        function applyTopBlackBar() {
            const height = parseInt(topBarHeight.value) || 0;
            if (height >= 0 && height <= 200) {
                blackBarSettings.top = height;
                applyBlackBars();
                saveBlackBarSettings();
                alert(`Top black bar set to ${height}px`);
            } else {
                alert('Please enter a value between 0 and 200');
            }
        }

        // Apply bottom black bar
        function applyBottomBlackBar() {
            const height = parseInt(bottomBarHeight.value) || 0;
            if (height >= 0 && height <= 200) {
                blackBarSettings.bottom = height;
                applyBlackBars();
                saveBlackBarSettings();
                alert(`Bottom black bar set to ${height}px`);
            } else {
                alert('Please enter a value between 0 and 200');
            }
        }

        // Apply black bars to all videos
        function applyBlackBarsToAllVideos() {
            applyBlackBars();
            saveBlackBarSettings();
            alert('Black bar settings applied to all videos');
        }

        // Reset black bars
        function resetBlackBars() {
            blackBarSettings.top = 0;
            blackBarSettings.bottom = 0;
            topBarHeight.value = 0;
            bottomBarHeight.value = 0;
            applyBlackBars();
            saveBlackBarSettings();
            alert('Black bars reset');
        }

        // Export passwords to TXT
        function exportPasswordsToTxt(passwordsToExport, type) {
            if (passwordsToExport.length === 0) {
                alert(`No ${type} passwords found!`);
                return;
            }
            
            let content = `Kachin Visions Empire - ${type} Passwords\n`;
            content += 'Generated on: ' + new Date().toLocaleString() + '\n\n';
            
            passwordsToExport.forEach((password, index) => {
                content += `${index + 1}. ${password.password}`;
                if (password.deviceId) {
                    content += ` (Used by device: ${password.deviceId.substring(0, 10)}...)`;
                }
                content += '\n';
            });
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${type}-passwords-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`Exported ${passwordsToExport.length} ${type} passwords to TXT file!`);
        }

        // Export passwords to PDF
        function exportPasswordsToPdf(passwordsToExport, type) {
            if (passwordsToExport.length === 0) {
                alert(`No ${type} passwords found!`);
                return;
            }
            
            // Use jsPDF library
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(20);
            doc.setTextColor(40);
            doc.text('Kachin Visions Empire', 20, 20);
            doc.setFontSize(16);
            doc.text(`${type} Passwords List`, 20, 30);
            
            // Add date
            doc.setFontSize(10);
            doc.text('Generated on: ' + new Date().toLocaleString(), 20, 40);
            
            // Add passwords
            let yPosition = 60;
            doc.setFontSize(12);
            
            passwordsToExport.forEach((password, index) => {
                if (yPosition > 270) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                let passwordText = `${index + 1}. ${password.password}`;
                if (password.deviceId) {
                    passwordText += ` (Used)`;
                }
                
                doc.text(passwordText, 20, yPosition);
                yPosition += 10;
            });
            
            // Save the PDF
            doc.save(`${type}-passwords-${new Date().toISOString().split('T')[0]}.pdf`);
            
            alert(`Exported ${passwordsToExport.length} ${type} passwords to PDF file!`);
        }

        // Delete used passwords
        function deleteUsedPasswords() {
            const usedPasswords = passwords.filter(p => p.deviceId);
            
            if (usedPasswords.length === 0) {
                alert('No used passwords found!');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${usedPasswords.length} used passwords? This action cannot be undone.`)) {
                if (navigator.onLine && !isOfflineMode) {
                    const batch = db.batch();
                    
                    usedPasswords.forEach(password => {
                        const passwordRef = db.collection('passwords').doc(password.id);
                        batch.delete(passwordRef);
                    });
                    
                    batch.commit().then(() => {
                        alert(`Successfully deleted ${usedPasswords.length} used passwords!`);
                        loadPasswords();
                    }).catch(error => {
                        console.error('Error deleting used passwords:', error);
                        alert('Error deleting used passwords. Please try again.');
                    });
                } else {
                    // Update local data only
                    passwords = passwords.filter(p => !p.deviceId);
                    savePasswordsOffline(passwords);
                    loadPasswords();
                    alert('Used passwords deleted locally. Will sync when online.');
                }
            }
        }

        // Delete unused passwords
        function deleteUnusedPasswords() {
            const unusedPasswords = passwords.filter(p => !p.deviceId);
            
            if (unusedPasswords.length === 0) {
                alert('No unused passwords found!');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${unusedPasswords.length} unused passwords? This action cannot be undone.`)) {
                if (navigator.onLine && !isOfflineMode) {
                    const batch = db.batch();
                    
                    unusedPasswords.forEach(password => {
                        const passwordRef = db.collection('passwords').doc(password.id);
                        batch.delete(passwordRef);
                    });
                    
                    batch.commit().then(() => {
                        alert(`Successfully deleted ${unusedPasswords.length} unused passwords!`);
                        loadPasswords();
                    }).catch(error => {
                        console.error('Error deleting unused passwords:', error);
                        alert('Error deleting unused passwords. Please try again.');
                    });
                } else {
                    // Update local data only
                    passwords = passwords.filter(p => p.deviceId);
                    savePasswordsOffline(passwords);
                    loadPasswords();
                    alert('Unused passwords deleted locally. Will sync when online.');
                }
            }
        }

        // Delete all passwords
        function deleteAllPasswords() {
            if (passwords.length === 0) {
                alert('No passwords found!');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ALL ${passwords.length} passwords? This action cannot be undone.`)) {
                if (navigator.onLine && !isOfflineMode) {
                    const batch = db.batch();
                    
                    passwords.forEach(password => {
                        const passwordRef = db.collection('passwords').doc(password.id);
                        batch.delete(passwordRef);
                    });
                    
                    batch.commit().then(() => {
                        alert(`Successfully deleted all ${passwords.length} passwords!`);
                        loadPasswords();
                    }).catch(error => {
                        console.error('Error deleting all passwords:', error);
                        alert('Error deleting all passwords. Please try again.');
                    });
                } else {
                    // Update local data only
                    passwords = [];
                    savePasswordsOffline(passwords);
                    loadPasswords();
                    alert('All passwords deleted locally. Will sync when online.');
                }
            }
        }

        // Create second admin
        function createSecondAdmin() {
            const username = document.getElementById('secondAdminUsername').value;
            const password = document.getElementById('secondAdminPassword').value;
            const adminType = document.querySelector('input[name="adminType"]:checked').value;
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }
            
            // In a real application, you would create a new user in Firebase Auth
            // and set custom claims for admin permissions
            alert(`Second admin ${username} created with ${adminType === 'full' ? 'full control' : 'read-only'} permissions`);
            
            document.getElementById('secondAdminUsername').value = '';
            document.getElementById('secondAdminPassword').value = '';
        }

        // Switch between screens
        function showScreen(screenNumber) {
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            
            document.getElementById(`screen${screenNumber}`).classList.add('active');
        }

        // Admin login
        function adminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            // Fixed admin credentials for Kachin Visions Empire
            if (username === 'Kachin Admin' && password === 'kachin@visions!01234') {
                // In a real app, you would sign in with Firebase Auth
                // For demo purposes, we'll just set the admin flag
                isAdmin = true;
                showScreen(2);
                loginModal.style.display = 'none';
                loginMessage.textContent = '';
                
                // Create a mock user for admin
                currentUser = {
                    uid: 'admin',
                    email: 'admin@kachinvisions.com'
                };
                
                // Set admin as online if connected
                if (navigator.onLine && !isOfflineMode) {
                    const userStatusRef = rtdb.ref('userStatus/' + currentUser.uid);
                    userStatusRef.set({
                        online: true,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });
                }
                
                // Load contact links data and admin message into admin panel
                loadContactLinks();
                loadAdminMessage();
                
                // Initialize rich text editor
                initRichTextEditor();
                
                // Initialize video reordering
                initVideoReordering();
            } else {
                loginMessage.textContent = 'Invalid credentials. Please try again.';
                loginMessage.style.color = 'var(--danger)';
            }
        }

        // Event Listeners
        adminLoginBtn.addEventListener('click', () => {
            loginModal.style.display = 'flex';
        });

        closeModal.addEventListener('click', () => {
            loginModal.style.display = 'none';
        });

        loginBtn.addEventListener('click', adminLogin);

        backToScreen1.addEventListener('click', () => {
            showScreen(1);
        });

        nextToScreen3.addEventListener('click', () => {
            showScreen(3);
        });

        backToScreen2.addEventListener('click', () => {
            showScreen(2);
        });

        backToScreen1FromContacts.addEventListener('click', () => {
            showScreen(1);
        });

        showContactLinksScreen.addEventListener('click', () => {
            showScreen(4);
        });

        unlockVideosBtn.addEventListener('click', unlockVideos);

        generatePasswordBtn.addEventListener('click', generatePasswords);

        addCloudinaryBtn.addEventListener('click', addCloudinaryVideo);

        addYoutubeBtn.addEventListener('click', addYouTubeVideo);

        addTelegramBtn.addEventListener('click', addTelegramVideo);

        addHlsBtn.addEventListener('click', addHlsVideo);

        addInstagramBtn.addEventListener('click', addInstagramVideo);

        addTiktokBtn.addEventListener('click', addTikTokVideo);

        // NEW: Contact link management event listeners
        addContactLinkBtn.addEventListener('click', addContactLink);
        saveContactLinksOrderBtn.addEventListener('click', saveContactLinksOrder);

        createSecondAdminBtn.addEventListener('click', createSecondAdmin);

        exportUnusedTxtBtn.addEventListener('click', () => {
            const unusedPasswords = passwords.filter(p => !p.deviceId);
            exportPasswordsToTxt(unusedPasswords, 'Unused');
        });

        exportUnusedPdfBtn.addEventListener('click', () => {
            const unusedPasswords = passwords.filter(p => !p.deviceId);
            exportPasswordsToPdf(unusedPasswords, 'Unused');
        });

        exportUsedTxtBtn.addEventListener('click', () => {
            const usedPasswords = passwords.filter(p => p.deviceId);
            exportPasswordsToTxt(usedPasswords, 'Used');
        });

        exportUsedPdfBtn.addEventListener('click', () => {
            const usedPasswords = passwords.filter(p => p.deviceId);
            exportPasswordsToPdf(usedPasswords, 'Used');
        });

        deleteUsedPasswordsBtn.addEventListener('click', deleteUsedPasswords);

        deleteUnusedPasswordsBtn.addEventListener('click', deleteUnusedPasswords);

        deleteAllPasswordsBtn.addEventListener('click', deleteAllPasswords);

        passwordSearch.addEventListener('input', renderPasswordList);

        clearCacheBtn.addEventListener('click', clearCache);

        saveAdminMessage.addEventListener('click', saveAdminMessageData);

        fullscreenBtn.addEventListener('click', toggleFullscreen);

        // PWA Install prompt event listeners
        pwaInstallConfirm.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const choiceResult = await deferredPrompt.userChoice;
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                } else {
                    console.log('User dismissed the install prompt');
                }
                deferredPrompt = null;
                hideInstallPrompt();
            }
        });

        pwaInstallCancel.addEventListener('click', hideInstallPrompt);

        // Black bar configuration event listeners
        applyTopBar.addEventListener('click', applyTopBlackBar);
        applyBottomBar.addEventListener('click', applyBottomBlackBar);
        applyToAllVideos.addEventListener('click', applyBlackBarsToAllVideos);
        resetBars.addEventListener('click', resetBlackBars);

        // Video order save button
        saveVideoOrderBtn.addEventListener('click', saveVideoOrder);

        // No internet modal continue button
        continueOfflineBtn.addEventListener('click', continueOffline);

        // Quality selector change handler
        qualitySelector.addEventListener('change', (e) => {
            currentVideoQuality = e.target.value;
            applyVideoQualitySettings(currentVideoElement);
        });

        // Initialize the app
        initApp();

        // Service Worker for offline functionality (Progressive Web App)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                .then(function(registration) {
                    console.log('ServiceWorker registration successful');
                })
                .catch(function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>